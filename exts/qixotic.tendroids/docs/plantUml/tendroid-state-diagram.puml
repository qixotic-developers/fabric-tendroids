@startuml tendroid-state-diagram

title Tendroid Lifecycle States

[*] --> Uninitialized : Tendroid created

state Uninitialized {
  [*] --> InitializingComponents
  InitializingComponents : Attributes set
  InitializingComponents : Components not yet created
  
  InitializingComponents --> GeometryCreated : create() called
  
  state GeometryCreated {
    [*] --> CreatingXform
    CreatingXform : Base Xform defined in USD
    CreatingXform --> GeneratingMesh : Xform created
    
    GeneratingMesh : CylinderGenerator creates mesh
    GeneratingMesh : Vertices generated
    GeneratingMesh : Topology defined
    GeneratingMesh --> InitializingComponents_Internal : Mesh created
    
    InitializingComponents_Internal : MaterialSafetyChecker created
    InitializingComponents_Internal : MeshVertexUpdater created
    InitializingComponents_Internal : WarpDeformer created (GPU)
    InitializingComponents_Internal : BreathingAnimator created
    InitializingComponents_Internal --> CheckingMaterial : Components ready
    
    CheckingMaterial : Initial material safety check
    CheckingMaterial --> [*] : Check complete
  }
  
  GeometryCreated --> [*] : is_created = True
}

Uninitialized --> Ready : Creation successful

state Ready {
  [*] --> Inactive
  
  state Inactive {
    state "Waiting" as InactiveWaiting
    InactiveWaiting : is_active = False
    InactiveWaiting : Not receiving updates
  }
  
  Inactive --> Active : set_active(True)
  Active --> Inactive : set_active(False)
  
  state Active {
    [*] --> CheckingMaterialSafety
    
    state CheckingMaterialSafety {
      [*] --> CheckCounter
      CheckCounter : Increment counter each frame
      CheckCounter --> PerformCheck : counter >= 30
      CheckCounter --> SkipCheck : counter < 30
      
      PerformCheck : Get material binding
      PerformCheck : Check for glass keywords
      PerformCheck --> MaterialSafe : No glass detected
      PerformCheck --> MaterialUnsafe : Glass detected
      
      SkipCheck --> [*]
    }
    
    CheckingMaterialSafety --> [*]
    
    state MaterialSafe {
      [*] --> UpdatingAnimation
      
      state UpdatingAnimation {
        [*] --> CalculatingWave
        CalculatingWave : BreathingAnimator.update(dt)
        CalculatingWave : Get wave parameters
        CalculatingWave --> CheckingWaveActive : Parameters returned
        
        CheckingWaveActive --> DeformingMesh : active = True
        CheckingWaveActive --> WaitingForNextCycle : active = False
        
        state DeformingMesh {
          [*] --> LaunchingWarpKernel
          LaunchingWarpKernel : WarpDeformer.update()
          LaunchingWarpKernel : GPU kernel execution
          LaunchingWarpKernel --> CopyingResults : Kernel complete
          
          CopyingResults : Copy deformed vertices to CPU
          CopyingResults --> UpdatingUSD : Data ready
          
          UpdatingUSD : MeshVertexUpdater.update_vertices()
          UpdatingUSD : Set USD points attribute
          UpdatingUSD --> [*] : Mesh updated
        }
        
        DeformingMesh --> CheckingBubble : Deformation complete
        
        CheckingBubble --> EmittingBubble : Wave at 95% height
        CheckingBubble --> [*] : No bubble emission
        
        state EmittingBubble {
          state "Placeholder" as BubblePlaceholder
          BubblePlaceholder : Currently just logging
          BubblePlaceholder : Phase 2: Create sphere prim
        }
        
        EmittingBubble --> [*]
        WaitingForNextCycle --> [*]
      }
      
      UpdatingAnimation --> [*] : Frame complete
    }
    
    state MaterialUnsafe {
      state "Blocked" as AnimationBlocked
      AnimationBlocked : is_glass_material = True
      AnimationBlocked : All updates skipped
      AnimationBlocked : Status: "Animation disabled"
      AnimationBlocked : Waiting for material change
      
      AnimationBlocked --> CheckingMaterialSafety : Next check cycle
    }
    
    MaterialSafe --> CheckingMaterialSafety : Next frame
    MaterialUnsafe --> CheckingMaterialSafety : Next check
  }
}

Ready --> ParameterUpdate : set_breathing_parameters()

state ParameterUpdate {
  [*] --> ValidatingMaterial
  ValidatingMaterial : Check if material safe
  ValidatingMaterial --> Rejecting : Glass material
  ValidatingMaterial --> Updating : Material safe
  
  Rejecting : Log warning
  Rejecting : Ignore parameter changes
  Rejecting --> [*]
  
  Updating : Update BreathingAnimator
  Updating : Recalculate timing values
  Updating --> [*]
}

ParameterUpdate --> Ready

Ready --> Destroying : destroy() called

state Destroying {
  [*] --> RemovingPrim
  RemovingPrim : stage.RemovePrim(base_path)
  RemovingPrim --> CleaningUpWarp : USD prim removed
  
  CleaningUpWarp : WarpDeformer.cleanup()
  CleaningUpWarp : Release CUDA memory
  CleaningUpWarp --> SettingFlags : Resources freed
  
  SettingFlags : is_created = False
  SettingFlags --> [*]
}

Destroying --> [*] : Cleanup complete

note right of CheckingMaterialSafety
  Material safety is checked
  every 30 frames (not per-frame)
  to minimize performance impact
end note

note right of MaterialUnsafe
  CRITICAL SAFETY FEATURE:
  When glass material detected,
  animation completely blocked
  to prevent GPU crashes
end note

note right of DeformingMesh
  GPU-accelerated deformation
  using NVIDIA Warp kernels
  provides smooth, organic motion
end note

@enduml
