= FastMeshUpdater USD Integration - Build & Test Guide
:toc:
:toclevels: 3

== Build Instructions

=== Step 1: Build C++ Extension

**Location:** `cpp/` directory

**Command:**
```batch
cd C:\Dev\Omniverse\fabric-tendroids\exts\qixotic.tendroids\qixotic\tendroids\cpp
build_usd.bat
```

**Expected Output:**
```
===============================================================================
Build SUCCESS!
===============================================================================
Output: fast_mesh_updater.pyd (with USD integration)
Version: 0.3.0-usd-integration
Mode: Full C++ (computation + USD)
```

**Troubleshooting:**

If CMake fails to find USD:
- Check USD_ROOT path in CMakeLists.txt (currently: C:/dev/omniverse-old/omnikitsdk-108.1.0)
- Verify omnikitsdk is installed
- Update USD_ROOT if your installation differs

If build fails with linker errors:
- Check that USD libraries exist in ${USD_ROOT}/lib
- Verify Visual Studio 2022 is installed
- Check that Python 3.10 is found

=== Step 2: Verify .pyd File

**Check:**
```batch
cd C:\Dev\Omniverse\fabric-tendroids\exts\qixotic.tendroids\qixotic\tendroids
dir fast_mesh_updater.pyd
```

**Expected:**
- File size: ~100-200 KB (with USD integration, larger than before)
- Date: Recent (today's date)
- If missing: Build failed, check build output

== Testing Instructions

=== Test 1: Python Import Test

**In Omniverse Script Editor:**
```python
try:
    from qixotic.tendroids import fast_mesh_updater
    updater = fast_mesh_updater.FastMeshUpdater()
    
    print(f"Version: {updater.get_version()}")
    print(f"Mode: {updater.get_mode()}")
    
    # Check for USD methods
    has_attach = hasattr(updater, 'attach_stage')
    has_register = hasattr(updater, 'register_mesh')
    has_update = hasattr(updater, 'update_mesh_vertices')
    
    print(f"attach_stage: {has_attach}")
    print(f"register_mesh: {has_register}")
    print(f"update_mesh_vertices: {has_update}")
    
    if has_attach and has_register and has_update:
        print("\n✅ SUCCESS: All USD methods present!")
    else:
        print("\n❌ FAIL: Missing USD methods")
        
except Exception as e:
    print(f"❌ ERROR: {e}")
    import traceback
    traceback.print_exc()
```

**Expected Output:**
```
Version: 0.3.0-usd-integration
Mode: Full C++ (computation + USD)
attach_stage: True
register_mesh: True
update_mesh_vertices: True

✅ SUCCESS: All USD methods present!
```

=== Test 2: Functional Test

**In Script Editor:**
```python
import omni.usd
from qixotic.tendroids import fast_mesh_updater
import numpy as np

try:
    # Get current stage
    ctx = omni.usd.get_context()
    stage = ctx.get_stage()
    stage_id = ctx.get_stage_id()
    
    print(f"Stage ID: {stage_id}")
    
    # Create updater
    updater = fast_mesh_updater.FastMeshUpdater()
    
    # Attach to stage
    if updater.attach_stage(stage_id):
        print("✅ Stage attached successfully")
    else:
        print("❌ Stage attachment failed")
        
    # Check attachment
    if updater.is_stage_attached():
        print("✅ Stage attachment confirmed")
    else:
        print("❌ Stage not attached")
        
except Exception as e:
    print(f"❌ ERROR: {e}")
    import traceback
    traceback.print_exc()
```

**Expected Output:**
```
Stage ID: <some number>
✅ Stage attached successfully
✅ Stage attachment confirmed
```

=== Test 3: Full Integration Test

**Steps:**
1. Open Omniverse Composer
2. Click "Spawn Tendroids" (create 15 Tendroids)
3. Click "Start Animation"
4. Watch console for logs

**Expected Console Output:**
```
[VertexDeformHelper] Initialized successfully for '/World/Tendroids/Tendroid_00/mesh' (total meshes: 1)
[VertexDeformHelper] Initialized successfully for '/World/Tendroids/Tendroid_01/mesh' (total meshes: 2)
...
[VertexDeformHelper] Initialized successfully for '/World/Tendroids/Tendroid_14/mesh' (total meshes: 15)
```

**NOT Expected (Python fallback warning):**
```
[VertexDeformHelper] FastMeshUpdater missing USD mesh methods
```

**If you see the fallback warning:**
- Build failed or .pyd not updated
- Check fast_mesh_updater.pyd file date
- Rebuild with build_usd.bat

=== Test 4: Performance Validation

**Run Stress Test:**
1. Click "Stress Test (Phase 2)" button
2. Wait for completion (~2 minutes)
3. Check final summary

**Expected Results:**
```
STRESS TEST SUMMARY
======================================================================

Count    Avg FPS      Frame Time   Min FPS    Max FPS   
----------------------------------------------------------------------
15       50-55        18-20 ms     48         58
20       48-52        19-21 ms     46         54
25       46-50        20-22 ms     44         52
30       45-50        20-22 ms     43         52

Frame Budget Analysis:
  Current: 20.0 ms
  Target: 25.0 ms (40 fps)
  Headroom: 5.0 ms (20.0%)

  ✓  GOOD - Headroom available for features
```

**Success Criteria:**
- ✅ 50+ fps @ 30 Tendroids
- ✅ 5+ ms headroom
- ✅ No Python fallback warnings
- ✅ Consistent performance across runs

**Failure Indicators:**
- ❌ <45 fps @ 30 Tendroids (fallback still active)
- ❌ Python fallback warnings in console
- ❌ No performance improvement from baseline

== Validation Checklist

**Build Phase:**
- [ ] build_usd.bat completes without errors
- [ ] fast_mesh_updater.pyd file created
- [ ] File size ~100-200 KB
- [ ] File date is recent

**Import Phase:**
- [ ] Python import succeeds
- [ ] Version shows "0.3.0-usd-integration"
- [ ] Mode shows "Full C++ (computation + USD)"
- [ ] All 5 USD methods present

**Integration Phase:**
- [ ] Stage attachment works
- [ ] Mesh registration works
- [ ] No fallback warnings when animating
- [ ] Multiple meshes can be registered

**Performance Phase:**
- [ ] 50+ fps @ 30 Tendroids sustained
- [ ] 5+ ms headroom measured
- [ ] ~25% FPS improvement vs baseline
- [ ] Stress test passes

== Troubleshooting

=== Build Errors

**"Cannot find USD headers":**
- Check USD_ROOT in CMakeLists.txt
- Verify path exists: C:/dev/omniverse-old/omnikitsdk-108.1.0/include
- Update path if your Kit SDK is in different location

**"Linker cannot find usd.lib":**
- Check USD_LIB_DIR in CMakeLists.txt
- Verify libraries exist in lib/ directory
- List required: usd.lib, usdGeom.lib, vt.lib, gf.lib, tf.lib, sdf.lib

**"Python 3.10 not found":**
- Kit SDK should provide Python 3.10
- May need to specify Python3_ROOT manually
- Add to CMake: -DPython3_ROOT=<path>

=== Runtime Errors

**"FastMeshUpdater missing USD mesh methods":**
- .pyd file not updated
- Rebuild with build_usd.bat
- Restart Composer after rebuild
- Check file modification date

**"Stage attachment failed":**
- Stage ID may be wrong type
- Check stage_id is integer (size_t)
- Try: `print(type(ctx.get_stage_id()))`

**"Mesh registration failed":**
- Mesh path may be invalid
- Check path exists in stage
- Print mesh_path before registration
- Verify mesh is UsdGeomMesh, not just Xform

=== Performance Issues

**No improvement (still ~40 fps @ 30):**
- USD methods not being called (fallback active)
- Check for fallback warning in console
- Verify mesh registration succeeded
- Use Python debugger to trace calls

**Improvement but not 240x:**
- Some meshes using fallback
- Check all meshes initialized successfully
- Count registered meshes vs total Tendroids
- May have partial success (some C++, some Python)

== Success Metrics

**Code Complete:**
- ✅ 5 USD methods implemented
- ✅ pybind11 bindings added
- ✅ Builds without errors
- ✅ .pyd file generated

**Integration Complete:**
- ✅ No fallback warnings
- ✅ All meshes use C++ path
- ✅ Multiple Tendroids work
- ✅ No crashes or errors

**Performance Complete:**
- ✅ 50+ fps @ 30 Tendroids
- ✅ 5+ ms headroom
- ✅ 25%+ FPS improvement
- ✅ Consistent across tests

== Next Steps After Success

**Phase 2C Complete When:**
1. Build succeeds
2. All tests pass
3. Performance targets met
4. Headroom confirmed

**Then Proceed To:**
1. Document performance improvement
2. Archive Python fallback code (keep for safety)
3. Begin transparency implementation (Phase 2D)
4. Monitor frame budget continuously

**Documentation:**
1. Update session handoff
2. Record performance gains
3. Note any build quirks
4. Create optimization summary

---

**Est. Time:** 30-60 minutes (build + test + validation)

**Status Indicators:**
- Build: PENDING
- Import: PENDING
- Integration: PENDING
- Performance: PENDING
