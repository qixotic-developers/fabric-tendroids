@startuml tendroid-state-diagram-v2

title Bubble State Machine - GPU Implementation

!define IDLE_COLOR #E8F5E9
!define ACTIVE_COLOR #FFF9C4
!define EXIT_COLOR #FFE0B2
!define DONE_COLOR #FFCDD2

state "Phase 0: IDLE" as Idle <<IDLE_COLOR>>
state "Phase 1: RISING" as Rising <<ACTIVE_COLOR>>
state "Phase 2: EXITING" as Exiting <<EXIT_COLOR>>
state "Phase 3: RELEASED" as Released <<ACTIVE_COLOR>>
state "Phase 4: POPPED" as Popped <<DONE_COLOR>>

[*] --> Idle : Tendroid created

Idle --> Rising : Breath timer expires\n(random interval)

note right of Idle
  **GPU State**:
  - phase = 0
  - y = 0
  - radius = cylinder_diameter
  - visible = false
  
  **Tendroid**:
  - No deformation
  - Wave-only motion
  
  **Duration**: 2-8 seconds (random)
end note

Rising --> Exiting : Bubble reaches\nmouth_exit_y

note right of Rising
  **GPU State**:
  - phase = 1
  - y increases (rise_speed)
  - radius grows → peak → shrinks
  - elongation applied
  - wave momentum added
  
  **Tendroid**:
  - Deformation bulge
  - Follows bubble Y position
  
  **Physics**:
  - Upward velocity: 35 units/s
  - Radial growth curve
  - Wave drift integration
  
  **Visibility**:
  - hide_until_clear option
  - or always visible
end note

Exiting --> Released : Y >= mouth_top

note right of Exiting
  **GPU State**:
  - phase = 2
  - transition phase
  - size stabilizes
  - wave momentum continues
  
  **Tendroid**:
  - Reduced deformation
  - Smooth transition
  
  **Duration**: ~0.3 seconds
  **Purpose**: Smooth visual handoff
end note

Released --> Popped : Lifetime expires\n(random)

note right of Released
  **GPU State**:
  - phase = 3
  - free-floating
  - wave drift only
  - gentle rise
  
  **Tendroid**:
  - No deformation
  - Wave-only motion
  
  **Physics**:
  - Upward: 15 units/s
  - Horizontal: wave drift
  - No elongation
  
  **Duration**: 1.5-3.5 seconds (random)
end note

Popped --> Idle : Recycle bubble\n(return to pool)

note right of Popped
  **GPU State**:
  - phase = 4
  - visible = false
  - triggers particle spray
  
  **Tendroid**:
  - No deformation
  - Wave-only motion
  
  **Particle System**:
  - Create 8-12 droplets
  - Radial spray pattern
  - Gravity + damping
  
  **Duration**: Instant (1 frame)
end note

note bottom
  **GPU State Machine Implementation**:
  - Runs entirely on GPU (BubblePhysics Warp kernel)
  - State transitions computed in parallel for all bubbles
  - Zero CPU overhead for physics
  - Wave integration on GPU
  - ~0.5ms for complete bubble system
  
  **Performance**:
  - 15 tendroids = 15 bubbles maximum
  - All bubbles updated in single kernel launch
  - 10x+ faster than CPU implementation
end note

@enduml
