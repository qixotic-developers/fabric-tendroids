@startuml tendroids-package-diagram-v2

title Tendroids V2 Package Structure - GPU-Accelerated Architecture

!define CORE_COLOR #E1F5FE
!define ANIMATION_COLOR #F3E5F5
!define SCENE_COLOR #E8F5E9
!define BUBBLES_COLOR #FFE0F0
!define BUILDERS_COLOR #FFF3E0
!define CONFIG_COLOR #C8E6C9
!define UI_COLOR #FFF9C4
!define UTILS_COLOR #FFE0B2
!define ENV_COLOR #B2EBF2
!define GPU_COLOR #FFCDD2

skinparam packageStyle rectangle
skinparam linetype ortho

package "qixotic.tendroids.v2" {
  
  package "core" CORE_COLOR {
    class BatchWarpDeformer <<GPU>>
    class BatchDeformKernel <<Warp Kernel>>
    class V2WarpDeformer
    class V2WarpTendroid
    class Tendroid <<interface>>
  }
  
  package "animation" ANIMATION_COLOR {
    class WaveController
    class WaveConfig
  }
  
  package "bubbles" BUBBLES_COLOR {
    class V2BubbleManager
    class BubbleGPUManager <<GPU>>
    class BubblePhysicsAdapter <<GPU Bridge>>
    class PopParticleGPUManager <<GPU>>
    class BubblePhysics <<Warp Kernel>>
    class PopParticlePhysics <<Warp Kernel>>
  }
  
  package "builders" BUILDERS_COLOR {
    class V2TendroidBuilder
    class CylinderGenerator
    class TerrainConform
  }
  
  package "config" CONFIG_COLOR {
    class ConfigLoader
    file "tendroids_config.json"
  }
  
  package "scene" SCENE_COLOR {
    class V2SceneManager
    class V2AnimationController
    class V2TendroidFactory
    class V2TendroidWrapper
  }
  
  package "environment" ENV_COLOR {
    class SeaFloorController
    class EnvironmentSetup
    class EnvironmentConfig
  }
  
  package "ui" UI_COLOR {
    class V2ControlPanel
    class SpawnControls
    class WaveControls
    class BubbleControls
    class ActionButtons
  }
  
  package "utils" UTILS_COLOR {
    class FabricHelper <<USDRT>>
    class MaterialHelper
  }
}

package "External Dependencies" {
  package "NVIDIA Warp" GPU_COLOR {
    class wp.kernel
    class wp.array
    class wp.launch
  }
  
  package "USDRT (Fabric)" {
    class FabricStage
    class VtArray
  }
  
  package "USD/Omniverse" {
    class UsdStage
    class UsdGeom
    class omni.kit
  }
  
  package "NumPy" {
    class np.array
  }
}

' Core GPU Pipeline
BatchWarpDeformer *-- BatchDeformKernel : launches
BatchWarpDeformer --> FabricHelper : writes via
BatchWarpDeformer ..> wp.kernel : uses
BatchDeformKernel ..> wp.array : operates on

V2WarpTendroid *-- V2WarpDeformer : contains
V2WarpTendroid ..|> Tendroid : implements

' Animation System
V2AnimationController *-- WaveController : contains
V2AnimationController --> BatchWarpDeformer : updates
V2AnimationController --> BubblePhysicsAdapter : updates
WaveController --> WaveConfig : uses

' Bubble GPU System
V2BubbleManager --> BubblePhysicsAdapter : manages
BubblePhysicsAdapter *-- BubbleGPUManager : contains
BubblePhysicsAdapter *-- PopParticleGPUManager : contains
BubbleGPUManager *-- BubblePhysics : launches
PopParticleGPUManager *-- PopParticlePhysics : launches

BubblePhysics ..> wp.kernel : Warp kernel
PopParticlePhysics ..> wp.kernel : Warp kernel

' Scene Management
V2SceneManager *-- V2AnimationController : contains
V2SceneManager *-- BatchWarpDeformer : creates
V2SceneManager --> V2TendroidFactory : uses
V2SceneManager --> BubblePhysicsAdapter : creates

V2TendroidFactory --> V2TendroidBuilder : uses
V2TendroidFactory --> V2TendroidWrapper : creates
V2TendroidWrapper *-- V2WarpDeformer : contains

' Builders
V2TendroidBuilder --> CylinderGenerator : uses
V2TendroidBuilder --> TerrainConform : uses
CylinderGenerator --> UsdGeom : creates meshes

' Environment
V2SceneManager --> SeaFloorController : creates
SeaFloorController --> EnvironmentSetup : uses
EnvironmentSetup --> EnvironmentConfig : uses

' UI Integration
V2ControlPanel --> V2SceneManager : controls
V2ControlPanel *-- SpawnControls : contains
V2ControlPanel *-- WaveControls : contains
V2ControlPanel *-- BubbleControls : contains
V2ControlPanel *-- ActionButtons : contains

WaveControls --> WaveController : binds to
BubbleControls --> V2BubbleManager : binds to

' Fabric Integration
FabricHelper --> FabricStage : accesses
FabricHelper --> VtArray : writes
BatchWarpDeformer --> FabricHelper : uses

' Configuration
config --> "tendroids_config.json" : reads

note right of BatchWarpDeformer
  **GPU Batch Deformation**
  - Single kernel for ALL vertices
  - Fabric GPU write path
  - Zero-copy mesh updates
  - 115 fps performance
end note

note right of BubblePhysicsAdapter
  **GPU Bubble System**
  - Complete lifecycle on GPU
  - Wave momentum integration
  - 10x+ faster than CPU
end note

note right of FabricHelper
  **Fabric Integration**
  - USDRT stage caching
  - Direct VtArray writes
  - "Deformable" tag support
  - Eliminated 10ms bottleneck
end note

note right of WaveController
  **Wave Animation**
  - NumPy vectorized
  - Graduated sway (baseâ†’tip)
  - 0.5ms CPU overhead
end note

legend right
  **V2 Architecture Principles**:
  
  **GPU-First Design**:
  - Warp kernels for compute
  - Fabric for mesh writes
  - Minimize CPU overhead
  
  **Performance**:
  - 115 fps (15 tendroids)
  - 93% GPU utilization
  - <1ms deformation time
  
  **Module Organization**:
  - core: GPU deformation
  - bubbles: GPU physics
  - animation: Wave control
  - scene: Orchestration
  - ui: User controls
endlegend

@enduml
