= Tendroids Extension
:toc:
:toclevels: 3
:numbered:

== Overview

Tendroids is an NVIDIA Omniverse extension that creates and animates interactive cylinder-based wormlike sea creatures using GPU-accelerated vertex deformation. The system provides smooth, organic breathing animations at real-time framerates while maintaining material safety to prevent GPU crashes.

=== Key Features

* *GPU-Accelerated Animation*: NVIDIA Warp kernels for smooth vertex deformation
* *Material Safety System*: Automatic detection and blocking of problematic glass materials
* *Multi-Creature Support*: Scene management for up to 15+ simultaneous Tendroids
* *Flexible Spawning*: Single-mode for detailed customization, multi-mode for batch creation
* *Real-Time Performance*: Optimized for 60fps with 15 creatures (30fps minimum)
* *Clean Architecture*: ~1,400 lines across 24 focused modules

== Installation

=== Requirements

* NVIDIA Omniverse USD Composer (or Create)
* Python 3.10 or higher
* NVIDIA Warp (for GPU acceleration)
* CUDA-capable GPU (recommended for best performance)

=== Setup Steps

1. **Copy Extension Folder**
+
----
Copy: exts/qixotic.tendroids/
To: <omniverse-app>/exts/qixotic.tendroids/
----

2. **Enable Extension**
+
* Open Omniverse USD Composer
* Window → Extensions
* Search for "Tendroids"
* Toggle extension to enabled

3. **Verify Installation**
+
* Check for "Tendroid Controls" in Window menu
* Console should show: `[TendroidsExtension] Starting up`

== Quick Start Guide

=== Basic Workflow

1. **Open Control Panel**
   * Window → Tendroid Controls
   * Panel appears with spawn settings and controls

2. **Configure Single Tendroid** (Detailed Control)
   * Set Count: 1
   * Adjust Diameter: 20 (width of cylinder)
   * Adjust Length: 100 (height of cylinder)
   * Wave Size: 40% (bulge length as percentage)
   * Amplitude: 0.35 (radial expansion, 35%)
   * Wave Speed: 40 (units per second)
   * Pause: 2.0 (seconds between breaths)

3. **Or Configure Multi-Spawn** (Batch Creation)
   * Set Count: 5-15
   * Area Width: 200 (spawn region width)
   * Area Depth: 200 (spawn region depth)
   * Segments: 16 (per Tendroid)

4. **Spawn and Animate**
   * Click "Spawn Tendroids"
   * Click "Start Animation"
   * Watch breathing animation
   * Use "Stop Animation" to pause
   * Use "Clear All" to remove all Tendroids

=== First Time Experience

For your first test:
1. Leave all default values
2. Click "Spawn Tendroids" (creates 1 Tendroid)
3. Click "Start Animation"
4. You should see a smooth breathing wave travel up the creature

== Architecture Overview

=== Module Structure

----
qixotic.tendroids/
├── core/                           # Tendroid geometry and animation
│   ├── tendroid.py                 # Main controller class
│   ├── tendroid_builder.py         # USD geometry creation
│   ├── tendroid_lifecycle.py       # State management
│   ├── cylinder_generator.py       # Procedural mesh generation
│   ├── warp_deformer.py            # GPU vertex deformation
│   ├── material_safety.py          # Glass material detection
│   └── mesh_updater.py             # USD vertex writes
├── animation/                      # Animation controllers
│   ├── breathing.py                # Breathing wave timing
│   └── idle_motion.py              # Subtle swaying (future)
├── scene/                          # Multi-Tendroid management
│   ├── manager.py                  # Scene coordinator
│   ├── animation_controller.py     # Update loop
│   └── tendroid_factory.py         # Creation patterns
├── ui/                             # User interface
│   ├── control_panel.py            # Main UI coordinator
│   ├── spawn_settings_ui.py        # Parameter controls
│   ├── action_buttons.py           # Event handlers
│   └── status_display.py           # Status display
└── utils/                          # Utilities
    └── math_helpers.py             # Math functions
----

=== Design Patterns

**Builder Pattern** (TendroidBuilder)
* Separates USD creation from main Tendroid class
* Initializes all components in correct order
* Returns fully-configured Tendroid ready for animation

**Factory Pattern** (TendroidFactory)
* Provides `create_single()` for detailed control
* Provides `create_batch()` for randomized spawning
* Handles parameter validation and logging

**Lifecycle Pattern** (TendroidLifecycle)
* Manages state transitions
* Handles activation/deactivation with safety checks
* Cleanup and resource management

**Component Pattern**
* Tendroid delegates to specialized components
* Each component has single responsibility
* Clean interfaces between components

== Animation System

=== Breathing Wave Mechanics

The breathing animation creates organic motion through:

**Traveling Bulge**
* Single wave moves from base to top
* Starts at zero expansion
* Peaks at wave center
* Returns to zero smoothly

**Mathematical Model**
* Uses raised cosine envelope for smooth transitions
* Zero displacement at wave edges, peak at center
* Formula: `envelope = 0.5 * (1 + cos(π * distance / half_bulge))`
* Radial expansion only (X and Z axes, Y unchanged)

**Warp GPU Kernel**
* Processes all vertices in parallel
* Skips flared base (below deform_start_height)
* Calculates distance from wave center
* Applies envelope function
* Computes radial displacement
* Writes deformed positions

**Configurable Parameters**
* Wave Speed: How fast wave travels (units/second)
* Bulge Length: Size as percentage of total length
* Amplitude: Maximum radial expansion (0-1 scale)
* Cycle Delay: Pause between breathing cycles

=== Material Safety System

**Critical Issue**: Glass and transparent materials with dynamic geometry cause GPU memory exceptions in path-traced rendering.

**Protection Mechanism**
* MaterialSafetyChecker monitors mesh materials
* Periodic checking every 30 frames
* Keyword-based detection: glass, transparent, translucent, omni, clear, crystal, refract
* Animation completely blocked when unsafe material detected
* Clear logging and status messages

**Usage Guidelines**
* Test animation with opaque materials first
* Apply glass materials AFTER validating animation
* Check console for material safety warnings
* UI shows "⚠️ Animation disabled" when blocked

== Parameter Reference

=== Single Tendroid Parameters

[cols="1,2,1,1"]
|===
|Parameter |Description |Range |Default

|Diameter
|Initial cylinder width
|2-100
|20.0

|Length
|Total cylinder height
|10-300
|100.0

|Wave Size (%)
|Bulge length as % of total
|5-50
|40.0

|Amplitude
|Maximum radial expansion
|0.0-1.0
|0.35

|Wave Speed
|Bulge travel speed (units/sec)
|10-200
|40.0

|Pause (sec)
|Delay between cycles
|0-10
|2.0
|===

=== Multi-Spawn Parameters

[cols="1,2,1,1"]
|===
|Parameter |Description |Range |Default

|Count
|Number of Tendroids
|1-15
|1

|Area Width
|Spawn region width
|50-1000
|200

|Area Depth
|Spawn region depth
|50-1000
|200

|Segments
|Vertical resolution per Tendroid
|8-32
|16
|===

=== Performance Guidelines

**Segment Count vs Quality**
* 8-12: Low quality, best performance
* 16: Good balance (default for multi-spawn)
* 24-32: High quality, smooth animation
* 32+: Diminishing returns, performance cost

**Tendroid Count vs FPS**
* 1-5: Excellent performance (60fps+)
* 6-10: Very good performance (50-60fps)
* 11-15: Good performance (40-50fps expected)
* 16-20: Acceptable performance (30-40fps expected)
* 20+: May need optimization

== Troubleshooting

=== Extension Won't Load

**Symptoms**: Extension not visible in Extensions window

**Solutions**:
* Verify extension folder in correct location
* Check extension.toml file exists
* Restart Omniverse
* Check console for Python import errors
* Verify Warp is installed

=== No Animation Visible

**Symptoms**: Tendroid appears but doesn't breathe

**Checklist**:
1. Click "Start Animation" button
2. Check console for material safety warnings
3. Verify glass material not applied
4. Check if mesh_prim is valid
5. Look for error messages in console

**Common Causes**:
* Animation not started
* Glass material blocking animation
* Invalid USD paths
* Component initialization failed

=== Poor Performance

**Symptoms**: Low FPS, stuttering animation

**Solutions**:
* Reduce Tendroid count
* Decrease segment count (use 12-16 instead of 32)
* Check GPU utilization
* Close other extensions
* Disable ray tracing temporarily
* Verify Warp GPU acceleration active

=== Material Safety Warning

**Symptoms**: Console shows "⚠️⚠️⚠️ GLASS MATERIAL DETECTED"

**Explanation**: This is intentional protection, not an error

**Actions**:
* Remove glass material
* Test with opaque material
* Animation will resume automatically
* Or accept that animation is blocked for safety

== API Reference

=== TendroidSceneManager

Main interface for managing Tendroids in scene.

==== create_tendroids()

[source,python]
----
def create_tendroids(
    count: int = 15,
    spawn_area: tuple = (200, 200),
    radius_range: tuple = (8, 12),
    length_range: tuple = (80, 120),
    num_segments: int = 16
) -> bool
----

Create multiple Tendroids with randomized positions and sizes.

**Parameters**:
* `count`: Number of Tendroids to create
* `spawn_area`: (width, depth) of spawning region
* `radius_range`: (min, max) radius for variation
* `length_range`: (min, max) length for variation
* `num_segments`: Vertical resolution per Tendroid

**Returns**: True if successful, False otherwise

==== create_single_tendroid()

[source,python]
----
def create_single_tendroid(
    position: tuple = (0, 0, 0),
    radius: float = 10.0,
    length: float = 100.0,
    num_segments: int = 32,
    bulge_length_percent: float = 40.0,
    amplitude: float = 0.35,
    wave_speed: float = 40.0,
    cycle_delay: float = 2.0
) -> bool
----

Create single Tendroid with custom parameters.

**Parameters**:
* `position`: (x, y, z) world position
* `radius`: Cylinder radius
* `length`: Total length
* `num_segments`: Vertical resolution (higher = smoother)
* `bulge_length_percent`: Wave size as % of length
* `amplitude`: Maximum radial expansion
* `wave_speed`: Wave travel speed
* `cycle_delay`: Pause between cycles

**Returns**: True if successful, False otherwise

==== start_animation()

[source,python]
----
def start_animation()
----

Begin animating all Tendroids. Subscribes to update event stream.

==== stop_animation()

[source,python]
----
def stop_animation()
----

Pause animation for all Tendroids. Unsubscribes from updates.

==== clear_tendroids()

[source,python]
----
def clear_tendroids(stage=None)
----

Remove all Tendroids from scene and cleanup resources.

**Parameters**:
* `stage`: USD stage (optional, will get current if None)

=== Tendroid

Individual Tendroid creature class.

==== create()

[source,python]
----
def create(stage, parent_path: str = "/World/Tendroids") -> bool
----

Create Tendroid geometry in USD stage. Delegates to TendroidBuilder.

**Parameters**:
* `stage`: USD stage
* `parent_path`: Parent prim path

**Returns**: True if successful

==== update()

[source,python]
----
def update(dt: float)
----

Update animation for current frame. Checks material safety periodically.

**Parameters**:
* `dt`: Delta time since last update (seconds)

==== set_active()

[source,python]
----
def set_active(active: bool)
----

Enable/disable animation. Respects material safety.

**Parameters**:
* `active`: Whether to activate animation

==== set_breathing_parameters()

[source,python]
----
def set_breathing_parameters(**kwargs)
----

Update breathing animation parameters at runtime.

**Keyword Arguments**:
* `wave_speed`: New wave speed
* `bulge_length_percent`: New bulge size
* `amplitude`: New amplitude
* `cycle_delay`: New pause duration

==== destroy()

[source,python]
----
def destroy(stage)
----

Remove from scene and cleanup resources.

**Parameters**:
* `stage`: USD stage

==== is_animation_enabled()

[source,python]
----
def is_animation_enabled() -> bool
----

Check if animation is safe (not blocked by glass material).

**Returns**: True if animation enabled, False if blocked

==== get_status_message()

[source,python]
----
def get_status_message() -> str
----

Get human-readable status message.

**Returns**: Status string (e.g., "✓ Active", "⚠️ Animation disabled: Glass material")

== Development Guide

=== Code Style Guidelines

**File Size**: Target 100-150 lines per file (excluding comments/blanks)

**Module Organization**:
* Class files: Controllers with business logic
* Helper files: Frequently-changing methods, utilities
* __init__.py: Module initialization and exports

**Design Principles**:
* Single Responsibility Principle
* Controllers delegate to helpers
* Clean interfaces between components
* Comprehensive docstrings

=== Adding New Features

**Example: Adding New Animation Type**

1. Create animator class in `animation/` folder
2. Follow BreathingAnimator pattern
3. Add to Tendroid initialization
4. Update TendroidBuilder
5. Add UI controls if needed

**Example: Custom Creature Variation**

1. Subclass Tendroid
2. Override specific methods
3. Register with TendroidFactory
4. Add spawn option in UI

=== Testing Approach

**Visual Validation**: Primary test method

**Performance Monitoring**: FPS tracking in viewport

**Material Safety Testing**: Test with various materials

**No Formal Unit Tests**: Ad-hoc testing based on needs

== Known Limitations

**Material Safety**:
* Keyword-based detection may miss renamed materials
* Conservative approach (may flag safe materials)
* Manual override not available (intentional safety measure)

**Animation Complexity**:
* Single traveling bulge only
* No multiple overlapping waves
* Trade-off for performance and simplicity

**No Self-Collision**:
* Tendroids can overlap in scene
* Not an issue with current spawn distribution
* Could add distance checks if needed

**Flared Base**:
* Pre-scaled at creation time
* Not dynamically adjustable
* Requires mesh regeneration to change

== Future Enhancements

See IMPLEMENTATION_STATUS.adoc for detailed Phase 2 and Phase 3 plans.

**Phase 2 Features**:
* Bubble creation and physics
* Environmental flora
* User interaction
* Advanced materials

**Phase 3 Features**:
* Idle motion integration
* Multiple animation variations
* LOD system for >20 Tendroids
* Additional creature behaviors

== Support and Resources

**Documentation**:
* PROJECT_OVERVIEW.adoc: Architecture and design rationale
* IMPLEMENTATION_STATUS.adoc: Current status and next steps
* CHANGELOG.adoc: Version history
* docs/plantUml/: Architecture diagrams

**Omniverse Resources**:
* Fabric/USDRT 7.6.1 docs: https://docs.omniverse.nvidia.com/kit/docs/usdrt.scenegraph/latest/overview.html
* NVIDIA Warp docs: https://nvidia.github.io/warp/

== License

Copyright (c) 2025 Qixotic Software

== Credits

Developed by Qixotic Software

Built with:
* NVIDIA Omniverse
* NVIDIA Warp
* Universal Scene Description (USD)
