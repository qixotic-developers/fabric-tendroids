= Warp Hash Grid Infrastructure
:toc: left
:toclevels: 3
:icons: font
:source-highlighter: highlight.js

== Overview

The Warp Hash Grid infrastructure provides GPU-accelerated spatial hashing for O(1) proximity queries between creatures and tendroids. This is the foundation for the Phase 1 proximity detection system.

=== Key Features

* *GPU-Accelerated* - All operations run on CUDA via Nvidia Warp
* *O(1) Neighbor Queries* - Hash grid provides constant-time lookups
* *Separate Point Sets* - Creatures and tendroids tracked independently
* *Dynamic Updates* - Positions can be updated each frame
* *Configurable* - Grid dimensions and detection thresholds are tunable

=== Related Tasks

[cols="1,3,1"]
|===
|Task |Description |Status

|TEND-15
|Set up Warp Hash Grid infrastructure
|✅ Complete

|TEND-64
|Initialize Warp HashGrid with scene dimensions
|✅ Complete

|TEND-65
|Create Warp arrays for position data
|✅ Complete

|TEND-66
|Implement grid rebuild on position updates
|✅ Complete

|TEND-67
|Integrate HashGrid with simulation loop
|✅ Complete
|===

== Architecture

=== Module Structure

[source]
----
qixotic/tendroids/proximity/
├── __init__.py              # Module exports
├── proximity_config.py      # Configuration dataclasses
├── hash_grid.py             # ProximityHashGrid controller
└── hash_grid_helper.py      # GPU kernels and utilities
----

=== Class Diagram

[source]
----
┌─────────────────────────┐
│   ProximityHashGrid     │
├─────────────────────────┤
│ - _grid: wp.HashGrid    │
│ - _creatures: PointSet  │
│ - _tendroids: PointSet  │
├─────────────────────────┤
│ + initialize()          │
│ + register_creatures()  │
│ + register_tendroids()  │
│ + update_creatures()    │
│ + rebuild()             │
│ + destroy()             │
└─────────────────────────┘
          │
          │ uses
          ▼
┌─────────────────────────┐
│      GridConfig         │
├─────────────────────────┤
│ dim_x, dim_y, dim_z     │
│ cell_size               │
│ device                  │
└─────────────────────────┘
----

== Configuration

=== Grid Configuration

[source,python]
----
from qixotic.tendroids.proximity import GridConfig, get_grid_config

# Default configuration
config = GridConfig()
# dim_x=128, dim_y=64, dim_z=128, cell_size=1.0

# Use preset
config = get_grid_config("small")   # 64x32x64, 0.5m cells
config = get_grid_config("large")   # 256x128x256, 2.0m cells

# Custom configuration
config = GridConfig(
    dim_x=100,
    dim_y=50,
    dim_z=100,
    cell_size=0.5,
    device="cuda:0"
)
----

=== Proximity Thresholds

[source,python]
----
from qixotic.tendroids.proximity import ProximityConfig

config = ProximityConfig(
    detection_radius=1.0,      # Maximum query distance
    approach_epsilon=0.04,     # Contact trigger (4cm)
    approach_minimum=0.15,     # Safe distance after repel (15cm)
    warning_distance=0.25      # Early warning zone (25cm)
)

# Validate configuration
assert config.validate(), "Invalid threshold order"
----

=== Threshold Diagram

[source]
----
                           detection_radius (1.0m)
                                    │
    ┌───────────────────────────────┴───────────────────────────────┐
    │                                                               │
    │                    warning_distance (25cm)                    │
    │                           │                                   │
    │    ┌──────────────────────┴──────────────────────┐           │
    │    │                                             │           │
    │    │           approach_minimum (15cm)           │           │
    │    │                    │                        │           │
    │    │    ┌───────────────┴───────────────┐       │           │
    │    │    │                               │       │           │
    │    │    │   approach_epsilon (4cm)      │       │           │
    │    │    │          │                    │       │           │
    │    │    │    ┌─────┴─────┐             │       │           │
    │    │    │    │  CONTACT  │             │       │           │
    │    │    │    └───────────┘             │       │           │
    │    │    │      DANGER                  │       │           │
    │    │    └───────────────────────────────┘       │           │
    │    │            APPROACHING                     │           │
    │    └─────────────────────────────────────────────┘           │
    │                     DETECTED                                 │
    └───────────────────────────────────────────────────────────────┘
                         IDLE (outside)
----

== Usage

=== Basic Usage

[source,python]
----
from qixotic.tendroids.proximity import ProximityHashGrid

# Create and initialize
grid = ProximityHashGrid()
grid.initialize()

# Register initial positions
creature_positions = [(0.0, 50.0, 0.0), (10.0, 50.0, 5.0)]
tendroid_positions = [(20.0, 0.0, 20.0), (30.0, 0.0, 30.0)]

grid.register_creatures(creature_positions)
grid.register_tendroids(tendroid_positions)

# Build grid for queries
grid.rebuild(search_radius=1.0)
----

=== Simulation Loop Integration

[source,python]
----
def on_update(dt):
    # Get current creature positions from simulation
    new_positions = get_creature_world_positions()
    
    # Update GPU arrays
    grid.update_creatures(new_positions)
    
    # Rebuild grid (required before queries)
    grid.rebuild(search_radius=proximity_config.detection_radius)
    
    # Now ready for proximity queries
    # (TEND-16 will add the query kernel)
----

=== Cleanup

[source,python]
----
def on_stop():
    grid.destroy()  # Release GPU resources
----

== GPU Kernels

=== Available Kernels

The helper module provides several Warp kernels for GPU operations:

[cols="2,3"]
|===
|Kernel |Purpose

|`copy_positions_kernel`
|Copy positions between GPU arrays with offset

|`find_neighbors_kernel`
|Find all neighbors within radius

|`compute_distances_kernel`
|Compute pairwise distances

|`compute_closest_distances_kernel`
|Find closest neighbor and distance
|===

=== Custom Kernel Example

[source,python]
----
import warp as wp
from qixotic.tendroids.proximity import ProximityHashGrid

@wp.kernel
def custom_proximity_kernel(
    grid: wp.uint64,
    query_points: wp.array(dtype=wp.vec3),
    radius: float,
    results: wp.array(dtype=int)
):
    tid = wp.tid()
    query = query_points[tid]
    
    count = int(0)
    for idx in wp.hash_grid_query(grid, query, radius):
        count = count + 1
    
    results[tid] = count

# Use with ProximityHashGrid
grid_id = proximity_grid.get_grid_id()
wp.launch(
    kernel=custom_proximity_kernel,
    dim=num_queries,
    inputs=[grid_id, query_points, radius, results]
)
----

== Testing

=== Run Tests

[source,bash]
----
# From extension root
cd exts/qixotic.tendroids

# Run hash grid tests
python -m pytest tests/test_hash_grid.py -v
python -m pytest tests/test_hash_grid_operations.py -v

# Run all proximity tests
python -m pytest tests/test_hash_grid*.py -v
----

=== Test Coverage

* Grid configuration validation
* Scene presets
* Grid initialization
* Position registration (creatures/tendroids)
* Position updates
* Grid rebuild
* Index classification (creature vs tendroid)
* Resource cleanup

== Performance Notes

=== Grid Sizing

Choose grid dimensions based on scene size:

[cols="1,1,2"]
|===
|Preset |Grid Size |Use Case

|`small`
|64x32x64
|Single tendroid, nearby creature

|`medium`
|128x64x128
|Multiple tendroids, moderate area

|`large`
|256x128x256
|Many tendroids, large environment
|===

=== Cell Size

The `cell_size` parameter affects query precision vs memory:

* *Smaller cells* (0.25-0.5m): More precise, more memory
* *Larger cells* (1-2m): Less memory, coarser queries

Recommended: Set `cell_size` close to `detection_radius`.

=== Rebuild Frequency

* Call `rebuild()` after each position update batch
* Do NOT rebuild between individual position updates
* Rebuild is O(n) but GPU-accelerated

== Next Steps

This infrastructure enables:

* *TEND-16*: Proximity kernel implementation
* *TEND-17*: Parameter tuning system
* *TEND-18*: Proximity state machine
