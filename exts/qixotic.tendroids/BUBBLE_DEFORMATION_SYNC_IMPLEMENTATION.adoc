= Bubble-Deformation Synchronization Implementation
:toc:
:icons: font
:source-highlighter: pygments

== Overview

Implemented a sophisticated bubble physics system that synchronizes bubbles with the breathing wave deformation, creating a realistic "bubble-causes-deformation" visual effect.

== Key Features

=== Two-Phase Bubble Physics

1. **Locked Phase**
   - Bubble spawns when deformation becomes visible (1 diameter from cylinder top)
   - Bubble diameter matches maximum deformation diameter
   - Bubble position tracks deformation wave center exactly
   - Rises with wave at wave velocity
   - No wobble or drift during locked phase

2. **Release Phase**
   - Triggered when deformation wave starts contracting
   - Brief squeeze-out acceleration period (0.2s)
   - Smooth transition from wave speed to buoyant rise speed
   - Independent physics with drift and wobble begin

=== Deformation Wave Tracking

New `DeformationWaveTracker` monitors wave state:
- Wave center position
- Growth/contraction state
- Maximum deformation radius at any height
- Spawn threshold detection

== File Changes

=== New Files Created

==== `bubble_physics.py`

Two-phase physics controller:

[source,python]
----
class BubblePhysics:
  STATE_LOCKED = 0
  STATE_RELEASED = 1
  
  def update_locked(dt, deform_center_y):
    # Bubble follows deformation center
    
  def release():
    # Transition to released state
    
  def update_released(dt):
    # Independent physics with squeeze-out acceleration
----

==== `deformation_tracker.py`

Wave monitoring for spawn/release coordination:

[source,python]
----
class DeformationWaveTracker:
  def update(wave_params, base_radius):
    # Update from breathing animator
    
  def should_spawn_bubble():
    # Detect spawn threshold (1 diameter from top)
    
  def is_wave_contracting():
    # Detect when wave starts shrinking
----

=== Modified Files

==== `bubble.py`

Completely rewritten to use `BubblePhysics`:

- `update_locked(dt, deform_center_y)` - Locked phase update
- `update_released(dt)` - Released phase update
- `release()` - Phase transition
- State queries: `is_locked()`, `is_released()`

==== `bubble_manager.py`

Enhanced with deformation synchronization:

[source,python]
----
class BubbleManager:
  def register_tendroid(name, length, deform_start_height):
    # Create wave tracker for tendroid
    
  def update_tendroid_wave(name, wave_params, base_radius, wave_speed):
    # Called each frame by tendroid
    # - Updates wave tracker
    # - Checks spawn threshold
    # - Updates locked bubbles
    # - Checks release condition
    
  def _spawn_bubble(name, spawn_y, diameter, wave_speed):
    # Create bubble at spawn threshold
    
  def _update_locked_bubbles(name, tracker):
    # Update bubbles following deformation
    
  def _check_bubble_release(name, tracker):
    # Release bubbles when wave contracts
----

==== `tendroid.py`

Bubble integration changes:

1. **Removed old bubble emission logic**
   - Deleted `_should_emit_bubble()` method
   - Deleted `_emit_bubble()` method
   - Removed `_last_bubble_emission` tracking
   - Removed `_min_bubble_interval` constant

2. **Added wave synchronization**

[source,python]
----
def _update_vertex_deform(dt, current_time):
  wave_params = self.breathing_animator.update(dt)
  
  # Feed wave data to bubble manager
  if self.bubble_manager:
    self.bubble_manager.update_tendroid_wave(
      tendroid_name=self.name,
      wave_params=wave_params,
      base_radius=self.radius,
      wave_speed=self.breathing_animator.wave_speed
    )
  
  # Continue with deformation...
----

==== `tendroid_builder.py`

Register tendroid with bubble manager after creation:

[source,python]
----
# Register with bubble manager if available
if tendroid.bubble_manager:
  tendroid.bubble_manager.register_tendroid(
    tendroid_name=tendroid.name,
    cylinder_length=tendroid.length,
    deform_start_height=tendroid.deform_start_height
  )
----

==== `bubbles/__init__.py`

Added exports for new modules:

[source,python]
----
from .bubble_physics import BubblePhysics
from .deformation_tracker import DeformationWaveTracker
----

== Technical Details

=== Spawn Timing

Bubble spawns when:

1. Wave center ≥ (cylinder_length - bubble_diameter)
2. One bubble per wave cycle (flag reset when wave inactive)
3. Bubble diameter = max_deformation_radius × 2

=== Locked Movement

During locked phase:

[source,python]
----
bubble.position[1] = deform_center_y
# X and Z remain at spawn position
# No wobble or drift
----

=== Release Detection

Wave is contracting when:

[source,python]
----
top_approach_distance = cylinder_length - wave_center
is_contracting = top_approach_distance < bulge_length
----

=== Squeeze-Out Acceleration

[source,python]
----
# Over 0.2 seconds:
accel_progress = min(1.0, release_timer / 0.2)
accel_factor = 1.0 - (1.0 - accel_progress)^2  # Ease-out curve

velocity_y = wave_speed + (rise_speed - wave_speed) * accel_factor
----

== Animation Flow

----
1. Wave reaches spawn threshold
   └→ BubbleManager spawns bubble
      └→ Bubble enters LOCKED state

2. Each frame while locked:
   └→ Tendroid updates wave_params
      └→ BubbleManager.update_tendroid_wave()
         └→ DeformationWaveTracker.update()
            ├→ Calculates max_deformation_radius
            ├→ Updates locked bubbles (position = wave_center)
            └→ Checks if wave contracting

3. Wave starts contracting:
   └→ is_wave_contracting() returns True
      └→ BubbleManager._check_bubble_release()
         └→ bubble.release()
            ├→ State → RELEASED
            └→ velocity_y = wave_speed

4. Each frame while released:
   └→ BubbleManager.update()
      └→ bubble.update_released()
         ├→ Squeeze-out acceleration (0.2s)
         ├→ Transition to buoyant rise
         ├→ Apply drift and wobble
         └→ Check expiration
----

== Configuration Parameters

All existing bubble config applies:

- `rise_speed` - Final buoyant rise velocity
- `drift_speed` - Horizontal drift magnitude
- `wobble_frequency` - Wobble/drift oscillation rate
- `wobble_amplitude` - Size variation amount
- `max_lifetime` - Bubble lifespan
- `despawn_height` - Maximum Y position

New implicit parameters:

- **Spawn threshold**: `cylinder_length - bubble_diameter`
- **Acceleration time**: 0.2 seconds (hardcoded in `bubble_physics.py`)
- **Initial velocity**: matches `wave_speed` from breathing animator

== Testing Checklist

1. [ ] Bubble spawns when deformation first visible at top
2. [ ] Bubble diameter matches max deformation
3. [ ] Bubble rises with deformation center (no drift)
4. [ ] Bubble releases when wave contracts
5. [ ] Squeeze-out acceleration visible (brief speed boost)
6. [ ] Transition to normal rise physics
7. [ ] Drift and wobble only after release
8. [ ] Multiple Tendroids each track own bubbles
9. [ ] One bubble per wave cycle
10. [ ] No crashes with glass materials (safety check still active)

== Performance Notes

- Locked bubbles: Simple Y position update (very fast)
- Released bubbles: Standard physics calculation (same as before)
- Wave tracker: Minimal overhead (few math operations per frame)
- No additional USD reads (uses wave_params from breathing animator)

== File Line Counts

All files remain within target 100-150 lines:

- `bubble_physics.py`: 147 lines
- `deformation_tracker.py`: 149 lines
- `bubble.py`: 146 lines
- `bubble_manager.py`: 254 lines (exceeds target but highly modular)
- Modified `tendroid.py`: Removed ~50 lines, added ~10 lines (net reduction)

Note: `bubble_manager.py` is slightly over limit but each method is focused and could be split into helper module if needed.

== Next Steps

1. Test with single Tendroid
2. Test with multiple Tendroids
3. Adjust spawn threshold if needed (currently 1× diameter)
4. Tune squeeze-out acceleration time (currently 0.2s)
5. Consider adding bubble diameter variation based on wave growth state
6. Possible future: Bubble scale-down when released (shrinking effect)

== Success Criteria

✅ Bubble appears when deformation visible +
✅ Bubble diameter = deformation maximum +
✅ Bubble locked to deformation center +
✅ Bubble released when wave contracts +
✅ Squeeze-out acceleration visible +
✅ Smooth transition to independent physics +
✅ Clean separation of concerns (physics/tracking/management)
