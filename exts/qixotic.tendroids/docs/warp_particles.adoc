= Warp Particle System Documentation
:author: qixotic
:date: November 20, 2025
:toc:
:toc-placement: preamble

This document describes the GPU-accelerated particle system for bubble pop effects in the Tendroids project.

== Overview

The Warp particle system replaces sphere-based particles with a high-performance GPU-accelerated point cloud, achieving significant performance improvements while maintaining visual quality.

== Architecture

=== Components

[source]
----
WarpPopParticleManager (bubble_particle_warp.py)
├── GPU Kernel (update_particles_kernel)
│   ├── Position integration
│   ├── Velocity updates (gravity)
│   └── Lifetime management
├── Particle Pool Management
│   ├── Pre-allocated arrays (2x max_particles)
│   ├── Round-robin slot allocation
│   └── CPU staging buffers
└── USD Rendering
    ├── UsdGeom.Points primitive
    ├── Dynamic color/size/opacity
    └── Batch updates per frame
----

=== Data Flow

1. **Bubble Pop Event** → `create_pop_spray(position, velocity)`
2. **CPU Generation** → Random velocities, lifetimes in staging arrays
3. **GPU Upload** → Selective slot updates preserving existing particles
4. **GPU Physics** → Parallel kernel execution for all particles
5. **USD Update** → Point cloud attribute updates
6. **Rendering** → Omniverse renders point cloud

== Performance

=== Metrics

[options="header"]
|===
| Configuration | FPS | Improvement
| Sphere particles (baseline) | 36.45 | -
| Warp particles (initial) | ~42 | +15%
| Warp particles (optimized) | ~45 | +23%
|===

=== Optimizations

* **Pre-allocated particle pool**: Eliminates allocation overhead
* **GPU parallel processing**: Updates all particles in single kernel launch
* **Selective uploads**: Only modified slots uploaded to GPU
* **Periodic cleanup**: Active count updated 10% of frames
* **Single USD primitive**: One point cloud vs. many spheres

== Configuration

Particle behavior is controlled via `BubbleConfig`:

[source,python]
----
config.max_particles = 100          # Maximum simultaneous particles
config.particles_per_pop = 7        # Particles per bubble pop
config.particle_lifetime = 1.0      # Base lifetime in seconds
config.particle_speed = 20.0        # Initial velocity magnitude
config.particle_size = 1.0          # Base particle size
----

== Visual Effects

=== Particle Lifecycle

1. **Birth** (0-30% lifetime)
   - Color: White
   - Size: 100%
   - Opacity: 100%

2. **Mid-life** (30-70% lifetime)
   - Color: Light blue
   - Size: 75%
   - Opacity: 100%

3. **Decay** (70-100% lifetime)
   - Color: Dark blue
   - Size: 50%
   - Opacity: Fading to 0%

=== Spray Pattern

* **Angular spread**: 360° horizontal
* **Elevation**: 0-45° upward bias
* **Velocity inheritance**: Adds bubble velocity to spray
* **Gravity**: 5.0 units/sec² downward acceleration

== GPU Kernel

The Warp kernel processes all particles in parallel:

[source,python]
----
@wp.kernel
def update_particles_kernel(
    positions, velocities, ages, lifetimes, alive_flags,
    gravity, dt, num_particles
):
    tid = wp.tid()  # Thread ID = particle index
    
    # Skip dead particles
    if alive_flags[tid] == 0:
        return
    
    # Age and lifetime check
    ages[tid] += dt
    if ages[tid] >= lifetimes[tid]:
        alive_flags[tid] = 0
        return
    
    # Physics update
    velocities[tid][1] -= gravity * dt
    positions[tid] += velocities[tid] * dt
----

== Integration

=== Scene Manager Usage

[source,python]
----
from qixotic.tendroids.scene import TendroidSceneManager

# Enable Warp particles
manager = TendroidSceneManager(use_warp_particles=True)

# System automatically falls back if Warp unavailable
if manager.get_particle_system_type() == "spheres":
    print("Using fallback sphere particles")
----

=== Direct Usage

[source,python]
----
from qixotic.tendroids.bubbles import WarpPopParticleManager
from qixotic.tendroids.config import BubbleConfig

config = BubbleConfig()
particle_mgr = WarpPopParticleManager(stage, config)

# Create particles at bubble pop
particle_mgr.create_pop_spray(
    pop_position=(x, y, z),
    bubble_velocity=[vx, vy, vz]
)

# Update physics each frame
particle_mgr.update(dt=0.016)  # 60 FPS

# Get status
count = particle_mgr.get_particle_count()
----

== Troubleshooting

=== Particles Not Visible

1. Check USD Stage for `/World/Bubbles/PopParticleCloud` prim
2. Verify point cloud has positions attribute
3. Ensure visibility is "inherited"
4. Check particle size > 0

=== Performance Issues

1. Reduce `max_particles` in config
2. Decrease `particles_per_pop`
3. Check GPU memory usage
4. Verify CUDA is enabled

=== Warp Not Available

System automatically falls back to sphere particles. To force Warp:

1. Ensure Omniverse Warp extension is enabled
2. Check CUDA drivers are installed
3. Verify GPU compute capability

== Future Enhancements

* **Collision detection**: Particles interact with sea floor
* **Fluid dynamics**: Realistic water behavior
* **Variable sizes**: Different particle sizes per pop
* **Texture support**: Sprite-based rendering
* **LOD system**: Distance-based detail reduction
