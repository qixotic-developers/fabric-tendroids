@startuml
title Tendroids Project - Activity Diagram: Spawn Tendroid Workflow (Refactored)

start

:User clicks "Spawn Tendroids" button;

:ActionButtons receives click event;

if (Spawn count == 1?) then (yes)
    :Use single Tendroid mode;
    partition "Single Tendroid Creation" {
        :Read custom parameters from SpawnSettingsUI;
        :SceneManager.create_single_tendroid();
        :TendroidFactory.create_single();
    }
else (no)
    :Use multi-Tendroid batch mode;
    partition "Batch Tendroid Creation" {
        if (Current Tendroid count < max?) then (yes)
            :Read spawn area from SpawnSettingsUI;
            :SceneManager.create_tendroids();
            :TendroidFactory.create_batch();
            :Generate random positions;
        else (no)
            :Display error: "Maximum count reached";
            stop
        endif
    }
endif

partition "Tendroid Construction" {
    :Create new Tendroid instance;
    :Tendroid.create(stage, parent_path);
    :TendroidBuilder.create_in_stage();

    fork
        partition "USD Geometry" {
            :Builder._create_usd_geometry();
            :Create base Xform at /World/Tendroids/;
            :CylinderGenerator.create_tendroid_cylinder();
            :Generate vertices with flared base;
            :Create UsdGeom.Mesh prim;
        }
    fork again
        partition "Component Initialization" {
            :Builder._initialize_components();
            
            :MaterialSafetyChecker(mesh_path);
            :Check for glass/transparent materials;
            note right
                CRITICAL: Glass materials
                can cause GPU crashes
                with dynamic geometry
            end note
            
            :MeshVertexUpdater(mesh_prim);
            :WarpDeformer(vertices);
            if (Warp GPU available?) then (yes)
                :Allocate GPU memory arrays;
                note right: GPU-accelerated
            else (no)
                :CPU fallback mode;
            endif
            
            :BreathingAnimator(params);
            :Initialize wave parameters;
        }
    end fork
    
    if (Glass material detected?) then (yes)
        :Log critical warning;
        :Block animation for safety;
        note right
            Animation will be disabled
            to prevent GPU crash
        end note
    else (no)
        :Enable animation;
    endif
}

:Add Tendroid to SceneManager list;

partition "Animation Setup" {
    :AnimationController.set_tendroids();
    if (Animation not running?) then (yes)
        :User clicks "Start Animation";
        :AnimationController.start();
        :Subscribe to update events;
    endif
}

:StatusDisplay.update_count();
:StatusDisplay.update_status("Created!");

:Display success in UI;

stop

@enduml
