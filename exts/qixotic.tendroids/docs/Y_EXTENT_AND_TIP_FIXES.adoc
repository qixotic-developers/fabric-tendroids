= Y-Extent and Bent Tip Fixes
:toc:

== Issues Fixed

1. ✅ **Y-extent check added** - Creature must vertically overlap tendroid
2. ✅ **Contact uses bent tip position** - Accurate collision with bent tendroid

== Bug 1: No Y-Extent Check

**Problem:**
```
Creature at (10, 50, 10) - 50 units above sea floor
Tendroid at (10, 0, 10) - base at sea floor, top at 20
Horizontal distance: 0 units (directly above)

Old behavior: TRIGGERED interaction (wrong!)
Should be: NO interaction (creature way above tendroid)
```

**Fix:**
```python
# Check vertical overlap FIRST
tendroid_bottom = tendroid.position[1]
tendroid_top = tendroid.position[1] + tendroid.length

creature_bottom = creature.position[1] - creature_length/2
creature_top = creature.position[1] + creature_length/2

# No overlap? No interaction!
if creature_top < tendroid_bottom or creature_bottom > tendroid_top:
    return no_interaction
```

**Now:**
- Creature swimming 20 units above → No interaction ✅
- Creature at same level → Interaction works ✅
- Creature 10 units below → No interaction ✅

== Bug 2: Contact Using Wrong Position When Bent

**Problem:**
```
Tendroid bent 25° away from creature
Base still at (0, 0, 0)
Tip moved to (-8.5, 0, 0) - 8.5 units away!

Old: distance = creature_to_BASE = 5 units → "contact!"
Reality: distance to TIP = 13.5 units → not touching!

Result: Phantom collisions in empty space
```

**Fix:**
```python
# Calculate bent tip position
angle_rad = radians(avoidance_angle)
tip_offset_x = length * sin(angle_rad) * (-horiz_dir_x)  # Away direction
tip_offset_z = length * sin(angle_rad) * (-horiz_dir_z)

tip_x = base_x + tip_offset_x
tip_z = base_z + tip_offset_z

# Use TIP distance for contact detection
distance_to_tip = sqrt((creature_x - tip_x)^2 + (creature_z - tip_z)^2)

if distance_to_tip <= contact_distance:
    # ACTUAL contact with bent cylinder!
```

**Geometry:**
```
Straight (0°):
Base ○                          Tip •
     └─────────────────────────────┘
     0                             20

Bent (25° away from creature):
Base ○                    Tip •
     └──────────────────╱
     0               8.5 units away horizontally
                     (20 * sin(25°) ≈ 8.5)

Creature at 5 units from base:
  Old: "5 < 10, contact!" ❌
  New: tip at 8.5, creature at 5, distance = 3.5 ✅
```

== Visual Example

```
BEFORE (BROKEN):
═══════════════════════════════════════
Creature swimming 30 units ABOVE tendroid:

    Y=30   ──X──  Creature
            ↓
            ↓ (no vertical overlap!)
            ↓
    Y=20    •  Tendroid top
            |
    Y=10    |  Tendroid middle
            |
    Y=0     ○  Tendroid base

Old: Triggered interaction ❌ (wrong!)


AFTER (FIXED):
═══════════════════════════════════════
Creature swimming 30 units ABOVE tendroid:

    Y=30   ──X──  Creature (bottom at Y=24)
            
    Y=20    •  Tendroid top
    
    Check: creature_bottom=24 > tendroid_top=20
    Result: NO INTERACTION ✅ (correct!)
```

```
BENT TIP COLLISION:
═══════════════════════════════════════

Before (base position):
                X Creature (5 units from base)
                ↓
    Base ○ ════════╱ Tip • (bent 25° away, 8.5 units from base)
    
    Old: distance to BASE = 5
         5 < 10 (contact!) → WRONG ❌
    
After (tip position):
                X Creature (5 units from base)
                |
                └─→ 3.5 units to tip
    Base ○          ╱ • Tip (8.5 units from base)
    
    New: distance to TIP = 3.5
         3.5 < 10 → No contact yet ✅
```

== New Log Output

You'll now see:

```
[Interaction] Tendroid_00 suppressed bubble 
  (creature within 45.3 units, Y overlap)

[Avoidance] Tendroid_00: 
  base_dist=30.2    ← Distance to base (for detection)
  tip_dist=35.8     ← Distance to bent tip (for contact)
  target=12.5°      ← Target bend angle
  current=10.8°     ← Current angle
  approach_vel=15.3 ← Approach speed

[Penetration] Tendroid_00: 
  depth=2.1
  repulsion=525.0
  tip_pos=(-8.3, 2.1)  ← Actual tip location
  dir=(0.92, 0, -0.38) ← Push away from TIP
  damping=7.5
```

Key differences:
- ✅ `Y overlap` confirmation in first log
- ✅ `base_dist` vs `tip_dist` shown separately
- ✅ `tip_pos` shows actual bent position
- ✅ Direction calculated from TIP not base

== Testing

**Test 1: Swim directly over tendroid**
Expected: No reaction, no bubble suppression

**Test 2: Approach bent tendroid**
Expected: 
- Bends away
- Contact at correct distance (accounting for bend)
- Push direction away from tip

**Test 3: Dive from above**
Expected:
- No reaction until Y-overlap
- Then normal avoidance

**Test 4: Compare distances**
Watch logs: `base_dist` should be closer than `tip_dist` when bent

## Math Reference

```python
# When bent at 25° for a 20-unit tendroid:
tip_offset = 20 * sin(25°) = 20 * 0.423 = 8.46 units

# Creature 5 units from base:
base_distance = 5.0 units
tip_distance = sqrt((5-8.46)^2) = 3.46 units

# 3.46 < 10 (contact distance)?
# No! So no phantom collision ✅
```

== Files Modified

```
scene/interaction_helper.py (v4):
  - Added Y-extent check (lines 68-82)
  - Calculate bent tip position (lines 155-166)
  - Use tip distance for contact (lines 174-230)
```

**Chat Capacity:** 90K/190K remaining

Ready to test after extension reload!
