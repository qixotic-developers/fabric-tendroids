@startuml
title Tendroids Project - Class Diagram (Refactored Architecture)

skinparam classAttributeIconSize 0
skinparam linetype ortho

package "Extension Entry Point" {
    class TendroidsExtension {
        - _window: ui.Window
        - _scene_manager: TendroidSceneManager
        - _control_panel: TendroidControlPanel
        + on_startup()
        + on_shutdown()
    }
}

package "UI Components" {
    class TendroidControlPanel {
        - scene_manager: TendroidSceneManager
        - spawn_settings: SpawnSettingsUI
        - action_buttons: ActionButtons
        - status_display: StatusDisplay
        + create_window()
        + destroy()
    }
    
    class SpawnSettingsUI {
        - spawn_count: int
        - single_diameter: float
        - single_length: float
        - amplitude: float
        + create_ui()
        + _on_count_changed()
    }
    
    class ActionButtons {
        - scene_manager: TendroidSceneManager
        + create_ui()
        + _on_spawn_clicked()
        + _on_start_clicked()
        + _on_stop_clicked()
    }
    
    class StatusDisplay {
        - status_label: ui.Label
        - count_label: ui.Label
        + update_status()
        + update_count()
    }
}

package "Scene Management" {
    class TendroidSceneManager {
        - tendroids: List[Tendroid]
        - animation_controller: AnimationController
        + create_tendroids(count, spawn_area)
        + create_single_tendroid(position, params)
        + start_animation()
        + stop_animation()
        + clear_tendroids()
    }
    
    class TendroidFactory <<static>> {
        + {static} create_single(stage, params)
        + {static} create_batch(stage, count, area)
    }
    
    class AnimationController {
        - tendroids: List[Tendroid]
        - update_subscription
        - is_running: bool
        + set_tendroids(tendroids)
        + start()
        + stop()
        + _on_update(dt)
    }
}

package "Core - Tendroid" {
    class Tendroid {
        - name: str
        - position: tuple
        - radius: float
        - length: float
        - is_active: bool
        + create(stage, parent_path)
        + update(dt)
        + destroy(stage)
        + set_active(active)
    }
    
    class TendroidBuilder <<static>> {
        + {static} create_in_stage(tendroid, stage)
        - {static} _create_usd_geometry()
        - {static} _initialize_components()
    }
    
    class TendroidLifecycle <<static>> {
        + {static} set_active(tendroid, active)
        + {static} set_breathing_parameters(tendroid, kwargs)
        + {static} destroy(tendroid, stage)
        + {static} get_status_message(tendroid)
    }
}

package "Core - Components" {
    class MaterialSafetyChecker {
        - mesh_path: str
        - is_glass_material: bool
        - check_counter: int
        + check_material()
        + should_check_now()
        + is_safe_for_animation()
    }
    
    class MeshVertexUpdater {
        - mesh_prim: UsdGeom.Mesh
        - points_attr
        + update_vertices(vertices)
        + is_valid()
    }
    
    class CylinderGenerator <<static>> {
        + {static} create_tendroid_cylinder(stage, path, params)
        - {static} _generate_vertices()
        - {static} _generate_faces()
    }
    
    class WarpDeformer {
        - device: str
        - vertex_positions: wp.array
        + update(wave_center, bulge_length, amplitude)
        + cleanup()
    }
}

package "Animation" {
    class BreathingAnimator {
        - time: float
        - wave_speed: float
        - amplitude: float
        - cycle_delay: float
        + update(dt)
        + set_parameters(kwargs)
        + should_emit_bubble()
    }
}

' Relationships - Extension
TendroidsExtension *-- TendroidSceneManager
TendroidsExtension *-- TendroidControlPanel

' Relationships - UI
TendroidControlPanel *-- SpawnSettingsUI
TendroidControlPanel *-- ActionButtons
TendroidControlPanel *-- StatusDisplay
ActionButtons --> TendroidSceneManager : controls

' Relationships - Scene
TendroidSceneManager *-- AnimationController
TendroidSceneManager ..> TendroidFactory : creates via
AnimationController "1" o-- "0..15" Tendroid : animates

' Relationships - Tendroid Core
Tendroid ..> TendroidBuilder : delegates creation
Tendroid ..> TendroidLifecycle : delegates lifecycle
TendroidBuilder ..> CylinderGenerator : uses
TendroidBuilder ..> MaterialSafetyChecker : creates
TendroidBuilder ..> MeshVertexUpdater : creates
TendroidBuilder ..> WarpDeformer : creates
TendroidBuilder ..> BreathingAnimator : creates

' Relationships - Runtime
Tendroid *-- MaterialSafetyChecker : monitors
Tendroid *-- MeshVertexUpdater : updates via
Tendroid *-- WarpDeformer : deforms via
Tendroid *-- BreathingAnimator : animates via

' Notes
note right of Tendroid
    Refactored to ~165 lines
    Delegates to Builder and
    Lifecycle for separation
    of concerns
end note

note right of MaterialSafetyChecker
    Critical: Detects glass materials
    that could cause GPU crashes
    with dynamic geometry
end note

note bottom of TendroidSceneManager
    Manages up to 15 Tendroids
    Target: 60fps (min 30fps)
    Clean separation via Factory
    and AnimationController
end note

note right of TendroidControlPanel
    Refactored from 401 to 102 lines
    Delegates to specialized
    UI components
end note

@enduml
