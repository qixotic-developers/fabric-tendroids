= Session Summary: Stress Testing System & Bubble Position Bug Fix
:doctype: article
:toc: left
:toclevels: 3

== Overview

This session accomplished two major milestones:

1. **Automated Stress Testing System** - Complete infrastructure for finding performance ceilings
2. **Critical Bubble Bug Fix** - Resolved bubble positioning issue where all bubbles spawned at world origin

**Performance Achievement:** 75fps with 15 Tendroids + active bubbles (65-75fps range), well above 30fps target!

== Part 1: Automated Stress Testing System

=== Architecture

Created comprehensive automated testing framework with three components:

==== Files Created
* `stress_test_controller.py` (150 lines)
** Orchestrates test scenarios
** Measures FPS with warmup periods
** Generates performance reports
** Automatic scenario progression

* `config/stress_test_config.json`
** 9 predefined test scenarios
** Configurable duration/warmup/sampling
** Baseline tests: 15/20/25/30 Tendroids (no bubbles)
** Bubble tests: 1/5/10/15 Tendroids (with bubbles)
** Combined: 30 Tendroids + bubbles (max load)

==== Integration Points
* `ui/action_buttons.py` - Added stress test button with start/stop toggle
* `ui/control_panel.py` - Added `update(dt)` forwarding
* `extension.py` - Subscribed to update loop for UI updates

=== How It Works

[source]
----
1. User clicks "Start Stress Test Suite" button
2. Controller clears scene and spawns Scenario 1 (15 Tendroids, no bubbles)
3. Waits 3 seconds for warmup
4. Samples FPS every 0.5 seconds for 15 seconds
5. Calculates AVG/MIN/MAX FPS
6. Reports PASS/FAIL against 30fps target
7. Automatically moves to Scenario 2
8. Repeats for all 9 scenarios
9. Generates summary table and saves to `stress_test_results.log`
----

=== Test Output Format

**Console:**
[source]
----
SCENARIO 1/9: Baseline_15
Tendroids: 15, Bubbles: False
Results: AVG=75.3 fps, MIN=72.1, MAX=78.7, Bubbles=0
✓ PASS - Exceeded target 30 fps
----

**Log File:**
[source]
----
Scenario: Baseline_15
  Tendroids: 15
  Bubbles Enabled: False
  Active Bubbles: 0
  Average FPS: 75.30
  Min FPS: 72.10
  Max FPS: 78.70
  Samples: 30

Analysis:
Scenarios passing 30 fps target: 9/9
----

=== Configuration Tuning

Edit `config/stress_test_config.json`:

* `duration_per_scenario`: Test length (default: 15s)
* `warmup_duration`: Stabilization period (default: 3s)
* `fps_sample_interval`: Sampling frequency (default: 0.5s)
* `target_fps`: Pass/fail threshold (default: 30fps)

Add custom scenarios in `scenarios` array with:
[source,json]
----
{
  "name": "Custom_Test",
  "description": "Description here",
  "tendroid_count": 20,
  "bubbles_enabled": true
}
----

== Part 2: Bubble Position Bug Fix

=== The Problem

**Symptom:** Only one "phantom bubble" visible despite console showing 14+ bubbles spawning

**Root Cause:** All bubbles were spawning at world origin `(0, 0, 0)` regardless of parent Tendroid location

**Evidence from Logs:**
[source]
----
[BubbleManager] Spawned 'bubble_Tendroid_03_0053' at y=122.0
[BubbleManager] Spawned 'bubble_Tendroid_04_0054' at y=122.8
[BubbleManager] Spawned 'bubble_Tendroid_01_0055' at y=123.8
...
(14 bubbles created but all at same XZ coordinates!)
----

=== The Investigation

**Debugging Steps:**
1. Enabled `debug_logging: true` in bubble config
2. Added critical debug messages in `TendroidBuilder`:
   * `✓ 'Tendroid_XX' HAS bubble_manager`
   * `✓ 'Tendroid_XX' registered with BubbleManager`
3. Discovered bubbles WERE spawning (system working)
4. Realized they were stacking at origin (visual issue)

**Key Discovery:** Line 160 in `bubble_manager.py`:
[source,python]
----
spawn_position = (0.0, spawn_y, 0.0)  # ❌ HARDCODED ORIGIN!
----

=== The Solution

==== Changed Files

**`bubble_manager.py`:**
* Added `tendroid_positions` dict to track each Tendroid's location
* Modified `register_tendroid()` to accept `position` parameter
* Changed bubble spawn to use actual Tendroid coordinates:
[source,python]
----
tendroid_pos = self.tendroid_positions.get(tendroid_name, (0.0, 0.0, 0.0))
spawn_position = (tendroid_pos[0], spawn_y, tendroid_pos[2])
----
* Added position to cleanup in `clear_tendroid_bubbles()`

**`tendroid_builder.py`:**
* Pass `position=tendroid.position` when registering with BubbleManager
* Enhanced debug logging to show position

**`bubble_helpers.py`:**
* Fixed undefined variable bug: `radius` → `diameter` in debug log

**`tendroid_lifecycle.py`:**
* Added bubble manager cleanup in `destroy()` method
* Prevents orphaned registrations after clearing Tendroids

=== Result

✅ All 15 Tendroids now emit bubbles from their actual positions
✅ Bubbles spread across the spawn area correctly
✅ No more "phantom bubble" stacking at origin
✅ Performance: 75fps → 65fps with active bubbles (excellent!)

== Performance Summary

**Current Metrics (15 Tendroids):**
* No bubbles: ~75 fps
* With bubbles: ~65-75 fps (depends on active bubble count)
* Well above 30fps target ✅
* 10fps overhead for bubble system is acceptable

**Performance Ceiling:**
Ready for stress testing to find maximum Tendroid count before dropping below 30fps!

== Bubble Configuration Updates

**Increased Bubble Lifetime:**
* `max_lifetime`: 10.0 → 30.0 seconds
* `despawn_height`: 200.0 → 300.0 units
* `debug_logging`: true → false (disable for production)

Bubbles now rise much longer before despawning, creating more impressive visual effect.

== Future Enhancements (Next Session Ideas)

=== Particle-Based Bubble Popping
Instead of bubbles simply disappearing, create particle effects:
* Small water droplet particles spray outward
* Brief sparkle/shimmer effect
* Could use NVIDIA Flow or custom particle system
* Triggered when bubble reaches despawn height or collides

=== Other Ideas
* **Bubble Clustering:** Bubbles occasionally merge when close together
* **Surface Behavior:** Different physics near water surface
* **Light Interaction:** Bubbles catch and refract light
* **Sound Effects:** Gentle bubble sounds on emission/pop
* **Variable Bubble Sizes:** Randomize within min/max range per spawn

== Files Modified This Session

**New Files:**
* `stress_test_controller.py` - Automated test orchestration
* `config/stress_test_config.json` - Test scenario definitions

**Modified Files:**
* `bubbles/bubble_manager.py` - Position tracking and spawn fix
* `bubbles/bubble_helpers.py` - Variable name bug fix
* `core/tendroid_builder.py` - Pass position to BubbleManager
* `core/tendroid_lifecycle.py` - Cleanup bubble registrations
* `ui/action_buttons.py` - Stress test button + update loop
* `ui/control_panel.py` - Forward updates to action buttons
* `extension.py` - UI update subscription
* `config/tendroids_config.json` - Bubble lifetime increase, debug logging off

== Key Learnings

**Debugging Distributed Systems:**
The bubble position bug was subtle because:
1. Bubbles WERE being created (console confirmed)
2. USD prims existed in scene graph
3. Physics calculations were correct
4. Only the spawn position was wrong
5. Visual evidence (one bubble) didn't match data (14 bubbles)

**Solution:** Added position tracking at registration time rather than trying to query USD stage dynamically.

**Performance Profiling:**
The automated stress test system will be invaluable for:
* Finding performance ceilings
* Identifying bottlenecks (CPU vs GPU vs scene graph)
* Testing optimizations quantitatively
* Regression testing after code changes

== Status: Phase 2D Complete ✅

**Bubble System Achievements:**
* ✅ Deformation-synchronized spawning
* ✅ Dynamic diameter growth
* ✅ Locked phase tracking
* ✅ Smooth release detection
* ✅ Independent free-rise physics
* ✅ Correct positioning per Tendroid
* ✅ Production-ready performance (75fps)
* ✅ Automated stress testing infrastructure

**Ready for:**
* Phase 2E: Stress Testing & Performance Analysis
* Phase 3: Environmental Enhancements (waves, flora, particles)
* Phase 4: Advanced Effects (bubble popping particles!)

== Quick Reference Commands

**Run Stress Test:**
1. Open Tendroid Controls panel
2. Click "Start Stress Test Suite"
3. Watch console for real-time results
4. Check `stress_test_results.log` for detailed report

**Tune Bubble Behavior:**
Edit `config/tendroids_config.json` → `bubble_system` section:
* `max_lifetime`: How long bubbles live (seconds)
* `despawn_height`: Y position where bubbles disappear
* `rise_speed`: Vertical velocity (units/sec)
* `diameter_multiplier`: Size tuning (1.25 = 25% larger)
* `debug_logging`: Enable verbose console output

**Reset Bubble Counter:**
Restart extension to reset bubble numbering from 0001

'''

**Session Completed:** Phase 2D Bubble System + Stress Testing Framework
**Next Session:** Phase 2E Stress Testing Analysis + Phase 3 Planning (Particle Effects!)
