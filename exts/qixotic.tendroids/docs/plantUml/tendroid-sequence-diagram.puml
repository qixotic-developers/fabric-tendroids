@startuml
title Tendroids Project - Spawn and Animation Sequence (Refactored)

actor User
participant "TendroidControlPanel" as UI
participant "ActionButtons" as Actions
participant "TendroidSceneManager" as Manager
participant "TendroidFactory" as Factory
participant "Tendroid" as Tendroid
participant "TendroidBuilder" as Builder
participant "CylinderGenerator" as Generator
participant "MaterialSafetyChecker" as Safety
participant "WarpDeformer" as Deformer
participant "BreathingAnimator" as Animator
participant "MeshVertexUpdater" as Updater
participant "AnimationController" as Controller
database "USD Stage" as Stage

== Tendroid Spawning (Single Mode) ==

User -> UI: Click "Spawn Tendroids"
activate UI

UI -> Actions: _on_spawn_clicked()
activate Actions

Actions -> Manager: create_single_tendroid(position, params)
activate Manager

Manager -> Factory: create_single(stage, params)
activate Factory

Factory -> Tendroid: new Tendroid(name, position, ...)
activate Tendroid
Tendroid --> Factory: tendroid instance
deactivate Tendroid

Factory -> Tendroid: create(stage, parent_path)
activate Tendroid

Tendroid -> Builder: create_in_stage(tendroid, stage)
activate Builder

== USD Geometry Creation ==

Builder -> Builder: _create_usd_geometry()
activate Builder

Builder -> Generator: create_tendroid_cylinder(...)
activate Generator
Generator -> Generator: Generate vertices\nwith flared base
Generator -> Stage: Create UsdGeom.Mesh
Generator --> Builder: mesh_prim, vertices, deform_start
deactivate Generator

deactivate Builder

== Component Initialization ==

Builder -> Builder: _initialize_components()
activate Builder

Builder -> Safety: new MaterialSafetyChecker(mesh_path)
activate Safety
Safety -> Safety: check_material()
Safety -> Stage: Check material binding
Stage --> Safety: material info
Safety --> Builder: is_safe
deactivate Safety

Builder -> Updater: new MeshVertexUpdater(mesh_prim)
activate Updater
Updater --> Builder: updater instance
deactivate Updater

Builder -> Deformer: new WarpDeformer(vertices, deform_start)
activate Deformer
Deformer -> Deformer: Allocate GPU arrays\n(wp.array)
Deformer --> Builder: deformer instance
deactivate Deformer

Builder -> Animator: new BreathingAnimator(length, ...)
activate Animator
Animator -> Animator: Initialize parameters
Animator --> Builder: animator instance
deactivate Animator

deactivate Builder

Builder --> Tendroid: creation complete
deactivate Builder

Tendroid --> Factory: tendroid instance
deactivate Tendroid

Factory --> Manager: created tendroid
deactivate Factory

Manager -> Manager: tendroids = [tendroid]
Manager -> Controller: set_tendroids([tendroid])
Manager --> Actions: success
deactivate Manager

Actions -> UI: update_status("Created!")
UI --> User: Status updated
deactivate Actions
deactivate UI

== Animation Loop (Every Frame) ==

loop Every Frame (60fps target)
    Controller -> Controller: _on_update(event)
    activate Controller

    loop For each Tendroid
        Controller -> Tendroid: update(dt)
        activate Tendroid

        Tendroid -> Safety: should_check_now()
        activate Safety
        Safety --> Tendroid: check this frame?
        deactivate Safety

        opt Periodic Check
            Tendroid -> Safety: check_material()
            activate Safety
            Safety --> Tendroid: is_safe
            deactivate Safety
        end

        alt Glass Material Detected
            Tendroid -> Tendroid: **BLOCK UPDATE**
            note right: Animation disabled\nfor safety
        else Safe Material
            Tendroid -> Animator: update(dt)
            activate Animator
            Animator -> Animator: Calculate wave position
            Animator --> Tendroid: wave_parameters
            deactivate Animator

            alt Wave Active
                Tendroid -> Deformer: update(wave_center, bulge_length, amplitude)
                activate Deformer
                Deformer -> Deformer: **GPU Kernel Execution**\nDeform vertices\nwith wave pattern
                Deformer --> Tendroid: deformed_vertices
                deactivate Deformer

                Tendroid -> Updater: update_vertices(deformed_vertices)
                activate Updater
                Updater -> Stage: Set points attribute
                Stage --> Updater: updated
                Updater --> Tendroid: success
                deactivate Updater
            end

            opt Bubble Emission
                Tendroid -> Animator: should_emit_bubble()
                Animator --> Tendroid: true
                Tendroid -> Tendroid: _emit_bubble()
            end
        end

        Tendroid --> Controller: frame complete
        deactivate Tendroid
    end

    Controller --> Controller: all updated
    deactivate Controller
end

note over Safety
    Periodic glass material detection
    CRITICAL for preventing GPU
    crashes with transparent materials
end note

note over Builder
    Builder pattern separates
    complex creation logic
    from main Tendroid class
end note

note over Stage
    USD Stage updates trigger
    viewport refresh in
    Omniverse Composer
end note

@enduml
