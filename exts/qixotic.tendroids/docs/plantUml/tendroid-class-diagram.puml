@startuml tendroid-class-diagram-v2

title Tendroids V2 Key Classes - GPU Architecture

!define GPU_COLOR #FFCDD2
!define FABRIC_COLOR #B39DDB

class V2SceneManager {
  - tendroids: list[V2TendroidWrapper]
  - batch_deformer: BatchWarpDeformer
  - bubble_manager: V2BubbleManager
  - gpu_bubble_adapter: BubblePhysicsAdapter
  - animation_controller: V2AnimationController
  --
  + create_tendroids(count, spawn_area)
  + start_animation()
  + stop_animation()
  + clear_tendroids()
}

class V2AnimationController {
  - _frame_count: int
  - _absolute_time: float
  - _use_fabric_write: bool
  - wave_controller: WaveController
  --
  + start(enable_profiling)
  + stop()
  + set_fabric_write(enabled)
  - _on_update(event)
  - _update_gpu_path(dt, wave_state)
  - _apply_batch_deformation()
}

class BatchWarpDeformer <<GPU>> {
  - tendroids: list
  - base_points_gpu: wp.array
  - out_points_gpu: wp.array
  - vertex_tendroid_ids: wp.array
  - bubble_y_gpu: wp.array
  - wave_dx_gpu: wp.array
  --
  + register_tendroid(tendroid, base_points)
  + build()
  + update_states(bubble_data, wave_state)
  + deform_all(): wp.array
  + apply_to_meshes_fabric(stage_id)
}

class "@wp.kernel\\nbatch_deform_kernel" as BatchKernel <<GPU>> {
  GPU kernel that processes:
  - ALL vertices from ALL tendroids
  - Bubble deformation
  - Wave displacement
  - Single kernel launch
  - ~1.0ms execution
}

class FabricHelper <<Fabric>> {
  - _stage_cache: dict
  --
  + get_fabric_stage(stage_id): FabricStage
  + write_mesh_points(prim_path, points, stage_id)
}

class WaveController {
  - config: WaveConfig
  - _phase: float
  - _cycle_time: float
  --
  + update(dt)
  + get_wave_state(): dict
  + get_displacement(tendroid_id, height_factor): tuple
}

class BubblePhysicsAdapter <<GPU>> {
  - gpu_manager: BubbleGPUManager
  - particle_manager: PopParticleGPUManager
  - _name_to_id: dict
  --
  + update_gpu(dt, config, wave_state)
  + trigger_bubble(name)
  + destroy()
}

class BubbleGPUManager <<GPU>> {
  - phases_gpu: wp.array
  - positions_gpu: wp.array
  - velocities_gpu: wp.array
  - radii_gpu: wp.array
  --
  + update(dt, config, wave_state)
  + get_bubble_states(): tuple
  + trigger_bubble(id)
}

class "@wp.kernel\\nbubble_physics_kernel" as BubbleKernel <<GPU>> {
  GPU kernel that:
  - Updates all bubble states
  - Phase transitions
  - Physics integration
  - Wave momentum
  - ~0.5ms execution
}

class V2TendroidWrapper {
  - name: str
  - position: tuple
  - mesh_prim: UsdGeom.Mesh
  - deformer: V2WarpDeformer
  --
  + apply_deformation_with_wave_state()
  + apply_wave_only_with_state()
}

class V2WarpDeformer {
  - base_points_list: list[np.ndarray]
  - cylinder_radius: float
  - max_amplitude: float
  --
  + deform_vertices_gpu(bubble_y, bubble_radius): np.ndarray
}

' Relationships
V2SceneManager *-- V2AnimationController : contains
V2SceneManager *-- BatchWarpDeformer : creates
V2SceneManager *-- BubblePhysicsAdapter : creates
V2SceneManager o-- V2TendroidWrapper : manages

V2AnimationController o-- WaveController : contains
V2AnimationController --> BatchWarpDeformer : updates
V2AnimationController --> BubblePhysicsAdapter : updates
V2AnimationController --> FabricHelper : writes via

BatchWarpDeformer ..> BatchKernel : launches
BatchWarpDeformer --> FabricHelper : writes via
BatchWarpDeformer o-- V2TendroidWrapper : registered

BubblePhysicsAdapter *-- BubbleGPUManager : contains
BubbleGPUManager ..> BubbleKernel : launches

V2TendroidWrapper *-- V2WarpDeformer : contains

note right of V2SceneManager
  **Entry Point**
  Orchestrates all systems
  Creates GPU resources
  Manages lifecycle
end note

note right of BatchWarpDeformer
  **GPU Batch Processing**
  - Single kernel for ALL vertices
  - Fabric GPU write path
  - Zero-copy to renderer
  - 115 fps performance
end note

note right of BubblePhysicsAdapter
  **GPU Bubble System**
  - Complete lifecycle on GPU
  - Wave momentum integration
  - 10x+ faster than CPU
end note

note right of FabricHelper
  **Fabric Integration**
  - Stage caching
  - Direct VtArray writes
  - Eliminated 10ms bottleneck
end note

note bottom
  **Performance (15 Tendroids)**:
  - Total: 8.7ms per frame (115 fps)
  - Deformation kernel: 1.0ms
  - Fabric writes: 0.8ms
  - Bubble physics: 0.5ms
  - Wave calc (CPU): 0.5ms
  - Rendering: 5.7ms
  
  **GPU Utilization**: 93%
  **Architecture**: Python + Warp GPU kernels
end note

@enduml
