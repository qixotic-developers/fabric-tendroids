= V2 Integration Plan: Building System Migration
:toc:
:toc-placement!:
:icons: font

toc::[]

== Executive Summary

Migrate v1's production-ready tendroid building system (multi-spawn, terrain conform, UI, bubbles with pop particles, wave effects) into v2's optimized Warp GPU architecture.

*Goal*: Create identical scenes in v2 that v1 produces, using v2's performance-optimized tendroids.

== Architecture Comparison

=== V1 System (Production Features)
[cols="1,3"]
|===
|Component |Description

|`TendroidSceneManager`
|High-level coordinator: creates sea floor, bubble manager, tendroids, animation

|`TendroidFactory`
|Batch spawning with interference checking, position randomization, aspect ratio variation

|`TendroidBuilder`
|USD geometry creation, terrain conforming, component initialization

|`Tendroid`
|Core class with breathing animation, wave effects, bubble emission hooks

|`AnimationController`
|Update loop subscription, wave controller integration, profiling

|`BubbleManager`
|Deformation-locked bubbles, pop detection, particle spray

|`WaveController`
|Ocean current synchronized motion for tendroids + bubbles

|UI Package
|`ControlPanel`, `SpawnSettingsUI`, `ActionButtons`, `WaveControls`, `BubbleControls`
|===

=== V2 System (Optimized Core)
[cols="1,3"]
|===
|Component |Description

|`V2WarpController`
|Single tendroid demo with single bubble

|`V2WarpTendroid`
|GPU-accelerated deformation via Warp kernels

|`V2WarpDeformer`
|Warp kernel for vectorized vertex computation

|`V2Bubble`
|Simple rising bubble (drives deformation, no pop particles)

|`V2BubbleVisual`
|USD sphere representation

|`SeaFloorController`
|(Duplicated from v1) Sea floor creation
|===

== Gap Analysis

=== Missing in V2
[cols="1,2,1"]
|===
|Feature |V1 Location |Priority

|Multi-tendroid spawning
|`TendroidFactory.create_batch()`
|HIGH

|Interference checking
|`TendroidFactory._check_interference()`
|HIGH

|Terrain conforming
|`terrain_conform.py`
|HIGH

|Flared base geometry
|`CylinderGenerator` + config
|HIGH

|Scene manager orchestration
|`TendroidSceneManager`
|HIGH

|Animation controller
|`AnimationController`
|HIGH

|Wave controller
|`WaveController`
|HIGH

|Bubble manager (full)
|`BubbleManager` + `BubbleManagerEnhanced`
|HIGH

|Pop particles
|`PopParticleManager`
|MEDIUM

|Breathing animator
|`BreathingAnimator`
|HIGH

|Full UI system
|`ui/*` package
|HIGH

|Config system
|JSON configs + `get_config_value()`
|HIGH
|===

=== Present in V2 (Keep)
- `V2WarpTendroid` - GPU-accelerated mesh
- `V2WarpDeformer` - Warp kernel deformation
- `V2Bubble` - Bubble physics model (extend, don't replace)
- `V2BubbleVisual` - Visual representation
- `SeaFloorController` - Sea floor (already ported)
- Material helper

== Integration Strategy

=== Phase 1: Core Building System
Create v2-compatible versions of:

. `v2/builders/tendroid_builder.py` - Adapt v1's TendroidBuilder for V2WarpTendroid
. `v2/builders/cylinder_generator.py` - Flared base geometry for v2
. `v2/builders/terrain_conform.py` - Port directly from v1
. `v2/builders/__init__.py` - Exports

=== Phase 2: Factory & Spawning
. `v2/scene/tendroid_factory.py` - Multi-spawn with interference checking
. `v2/scene/__init__.py` - Exports

Key adaptations:
- Replace `Tendroid` class references with `V2WarpTendroid`
- Integrate `V2WarpDeformer` into build process
- Keep uniform radius optimization

=== Phase 3: Scene Management
. `v2/scene/manager.py` - V2SceneManager
. `v2/scene/animation_controller.py` - Update loop for v2 tendroids

Key adaptations:
- Use `V2WarpTendroid.apply_deformation()` instead of breathing animator
- Integrate wave controller with v2 deformation

=== Phase 4: Animation & Wave System
. `v2/animation/wave_controller.py` - Port directly from v1
. `v2/animation/breathing_animator.py` - Adapt for v2 bubble-guided model
. `v2/animation/__init__.py` - Exports

Key insight: V2's deformation is bubble-guided, not breathing-guided. Options:
- *Option A*: Keep v2's bubble-driven model, remove breathing
- *Option B*: Add breathing overlay to v2 (complexity)
- *Recommendation*: Option A - bubble-driven is the v2 paradigm

=== Phase 5: Bubble System Integration
. `v2/bubbles/bubble_manager.py` - Full manager with pop detection
. `v2/bubbles/bubble_physics.py` - Port rise physics + wave drift
. `v2/bubbles/bubble_particle.py` - Pop particle manager
. `v2/bubbles/bubble_config.py` - Configuration
. Update `v2/bubbles/__init__.py`

Key adaptations:
- V2 bubble drives deformation (bubble_y, bubble_radius → apply_deformation)
- Add pop timing, particle spray
- Add wave drift from v1

=== Phase 6: UI System
. `v2/ui/control_panel.py` - Main panel
. `v2/ui/spawn_settings_ui.py` - Spawn configuration
. `v2/ui/action_buttons.py` - Spawn, start, stop, clear
. `v2/ui/wave_controls.py` - Wave parameters
. `v2/ui/bubble_controls.py` - Bubble parameters
. `v2/ui/status_display.py` - Status labels
. `v2/ui/__init__.py` - Exports

=== Phase 7: Config System
. `v2/config/tendroids_config.json` - Full config from v1
. Update `v2/config/config_loader.py` if needed

== Implementation Details

=== V2WarpTendroid Extensions Needed

The current `V2WarpTendroid` needs:
. Flared base geometry option
. World position property
. Name/ID property
. Wave displacement integration
. `destroy()` cleanup hook

[source,python]
----
class V2WarpTendroid:
    def __init__(
        self, stage, path, radius, length,
        radial_segments=24, height_segments=48,
        max_amplitude=0.8, bulge_width=0.9,
        # NEW PARAMETERS:
        flare_height_percent=15.0,
        flare_radius_multiplier=2.0,
        name=None,
        position=(0, 0, 0)
    ):
        self.name = name or path.split("/")[-1]
        self.position = position
        # ... existing code ...
----

=== Scene Manager Pattern

[source,python]
----
class V2SceneManager:
    """Coordinates multi-tendroid scene with bubbles."""
    
    def __init__(self):
        self.tendroids = []
        self.bubble_manager = None
        self.animation_controller = None
        self.wave_controller = WaveController()
    
    def create_tendroids(self, count, spawn_area, ...):
        """Create batch of V2 tendroids."""
        # 1. Ensure sea floor
        # 2. Create bubble manager
        # 3. Use factory to create V2WarpTendroids
        # 4. Wire to animation controller
----

=== Animation Controller Pattern

[source,python]
----
class V2AnimationController:
    """Update loop for V2 system."""
    
    def _on_update(self, event):
        dt = event.payload.get('dt', 1/60)
        
        # Update wave controller
        self.wave_controller.update(dt)
        
        # Update each tendroid
        for i, tendroid in enumerate(self.tendroids):
            # Get bubble state for this tendroid
            bubble = self.bubble_manager.get_bubble(tendroid.name)
            
            # Apply deformation (bubble position drives it)
            tendroid.apply_deformation(bubble.y, bubble.get_current_radius())
            
            # Apply wave displacement to vertices
            self._apply_wave_displacement(tendroid, i)
        
        # Update bubble manager
        self.bubble_manager.update(dt, self.wave_controller)
----

== File Creation Checklist

=== New Directories
- `v2/builders/`
- `v2/scene/`
- `v2/animation/`
- `v2/ui/`

=== New Files (Priority Order)
[cols="1,2,1"]
|===
|File |Description |Lines (est)

|`v2/builders/__init__.py`
|Exports
|~15

|`v2/builders/cylinder_generator.py`
|Flared base mesh generation
|~120

|`v2/builders/terrain_conform.py`
|Port from v1
|~75

|`v2/builders/tendroid_builder.py`
|V2 tendroid factory
|~150

|`v2/scene/__init__.py`
|Exports
|~15

|`v2/scene/tendroid_factory.py`
|Multi-spawn logic
|~140

|`v2/scene/animation_controller.py`
|Update loop
|~130

|`v2/scene/manager.py`
|Scene orchestration
|~150

|`v2/animation/__init__.py`
|Exports
|~10

|`v2/animation/wave_controller.py`
|Port from v1
|~100

|`v2/bubbles/bubble_manager.py`
|Full manager
|~200

|`v2/bubbles/bubble_physics.py`
|Physics model
|~100

|`v2/bubbles/bubble_particle.py`
|Pop particles
|~120

|`v2/bubbles/bubble_config.py`
|Configuration
|~50

|`v2/ui/__init__.py`
|Exports
|~20

|`v2/ui/control_panel.py`
|Main panel
|~120

|`v2/ui/spawn_settings_ui.py`
|Spawn settings
|~150

|`v2/ui/action_buttons.py`
|Action buttons
|~150

|`v2/ui/wave_controls.py`
|Wave controls
|~80

|`v2/ui/bubble_controls.py`
|Bubble controls
|~100

|`v2/ui/status_display.py`
|Status labels
|~60
|===

=== Modified Files
[cols="1,2"]
|===
|File |Changes

|`v2/core/warp_tendroid.py`
|Add position, name, flare options

|`v2/bubbles/bubble.py`
|Add pop timing, velocity, state machine

|`v2/bubbles/bubble_visual.py`
|Add visibility toggle

|`v2/__init__.py`
|Export new modules
|===

== Testing Strategy

=== Unit Tests
. Cylinder generator with flare
. Terrain conforming
. Interference checking
. Bubble physics

=== Integration Tests
. Single tendroid spawn + animation
. Multi-tendroid spawn (15)
. Bubble emission + pop
. Wave effects on tendroids + bubbles

=== Performance Tests
. 15 tendroids at 50+ fps
. 30 tendroids stress test
. Bubble + particle load

== Implementation Order (Next Chat)

. Create directory structure
. Port `cylinder_generator.py` with flare support
. Port `terrain_conform.py`
. Create `tendroid_builder.py` for V2
. Create `tendroid_factory.py`
. Create `animation_controller.py`
. Create `manager.py`
. Port `wave_controller.py`
. Extend bubble system
. Create UI modules
. Integration testing

== Notes

=== Key Architectural Difference
V1: Breathing animation drives deformation → bubble spawns at wave peak
V2: Bubble position drives deformation → deformation follows bubble

*Resolution*: Keep v2's bubble-driven paradigm. The bubble manager controls bubble lifecycle (spawn, rise, pop). Each tendroid tracks its own bubble. Deformation follows bubble.

=== Wave Integration
Both systems can use the same WaveController for ocean current effects. Apply wave displacement AFTER bubble-driven deformation.

=== Performance Considerations
- V2's Warp kernels handle deformation efficiently
- Keep uniform radius for potential GPU batching
- Pop particles should use v1's efficient system
