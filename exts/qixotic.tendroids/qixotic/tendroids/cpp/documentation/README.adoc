= FastMeshUpdater C++ Extension
:toc: left
:toclevels: 3
:icons: font
:source-highlighter: pygments

High-performance mesh vertex updates for Tendroids animation system.

== Phase 1: Hello World (Current)

Basic pybind11 integration to verify CLion + Visual Studio 2022 toolchain.

=== Prerequisites

==== Software Requirements

* *CLion* (with CMake support)
* *Visual Studio 2022* (C++ compiler and build tools)
* *Python 3.10* (from Omniverse Kit SDK)
* *pybind11*: `pip install pybind11`
* *NVIDIA Omniverse Composer 2024.1.0* (or your Kit SDK version)

=== Quick Start

==== 1. Open Project in CLion

----
File â†’ Open â†’ C:\Dev\Omniverse\fabric-tendroids\exts\qixotic.tendroids\qixotic\tendroids\cpp
----

==== 2. Configure CMake

If not auto-detected:

* Settings â†’ Build, Execution, Deployment â†’ CMake
* Build type: `Release`
* CMake options:
+
----
-DKIT_SDK_PATH="C:/Users/YOUR_USERNAME/AppData/Local/ov/pkg/composer-2024.1.0"
----

==== 3. Build

Build â†’ Build Project (Ctrl+F9)

==== 4. Test

[source,bash]
----
cd C:\Dev\Omniverse\fabric-tendroids\exts\qixotic.tendroids\qixotic\tendroids
python test_phase1.py
----

=== Command Line Build

[source,bash]
----
cd C:\Dev\Omniverse\fabric-tendroids\exts\qixotic.tendroids\qixotic\tendroids\cpp
mkdir cmake-build-release
cd cmake-build-release
cmake .. -G "Visual Studio 17 2022" -A x64
cmake --build . --config Release
----

=== Expected Output

[source]
----
======================================================================
FastMeshUpdater Phase 1 Tests - Hello World
======================================================================

Found module at: C:\Dev\Omniverse\...\cpp\cmake-build-release\Release\fast_mesh_updater.pyd
[PASS] Successfully imported fast_mesh_updater module
  Module version: 0.1.0-alpha-phase1

----------------------------------------------------------------------
Testing module-level functions...
----------------------------------------------------------------------
[PASS] hello_world() = 'Hello from C++ FastMeshUpdater module!'

----------------------------------------------------------------------
Testing FastMeshUpdater class...
----------------------------------------------------------------------
[PASS] FastMeshUpdater instance created

[PASS] get_version() = '0.1.0-alpha-phase1'
[PASS] hello_world() = 'Hello from C++ FastMeshUpdater v0.1.0-alpha-phase1'
[PASS] add_numbers(42, 58) = 100
[PASS] echo_array([1.0, 2.0, 3.0, 4.0, 5.0]) = [2.0, 4.0, 6.0, 8.0, 10.0]

======================================================================
[SUCCESS] All tests PASSED - Phase 1 complete!
======================================================================
----

== Architecture

[plantuml, phase1-architecture, svg]
----
@startuml
!theme plain
skinparam backgroundColor #FEFEFE
skinparam componentStyle rectangle

package "Python Layer" {
  [test_phase1.py] as test
}

package "pybind11 Bindings" {
  [python_bindings.cpp] as bindings
}

package "C++ Implementation" {
  [FastMeshUpdater Class] as cpp
  [fast_mesh_updater.h] as header
  [fast_mesh_updater.cpp] as impl
}

package "Future: Phase 2+" {
  [USD/Fabric API] as usd
}

test -down-> bindings : import
bindings -down-> cpp : calls
cpp ..> usd : (Phase 2+)
header <-right- impl : includes

note right of cpp
  Phase 1: Simple test functions
  - get_version()
  - add_numbers()
  - echo_array()
end note

note right of usd
  Not yet implemented
  - Stage attachment
  - Mesh registration
  - Vertex updates
end note

@enduml
----

== Troubleshooting

=== Import Error

*Problem:* `ImportError: DLL load failed` or `ModuleNotFoundError: No module named 'fast_mesh_updater'`

*Solutions:*

. Check that `fast_mesh_updater.pyd` exists in `cpp/cmake-build-release/Release/`
. Verify Python version matches Kit SDK (should be 3.10)
. Rebuild: `cmake --build . --config Release --clean-first`

=== CMake Configuration Failed

*Problem:* CMake can't find Kit SDK or pybind11

*Solutions:*

. Install pybind11: `pip install pybind11`
. Set Kit SDK path explicitly:
+
[source,bash]
----
cmake .. -DKIT_SDK_PATH="C:/path/to/your/kit-sdk"
----
. Verify path exists and contains `include/` and `lib/` folders

=== Linker Errors

*Problem:* LNK2019 unresolved external symbol errors

*Solutions:*

. Ensure Visual Studio 2022 is properly installed with C++ tools
. Check Python library paths match your Kit SDK Python
. Verify build type matches (Release vs Debug)

=== Wrong Python Version

*Problem:* Module built for Python 3.10 but running with different version

*Solutions:*

. Use Python from Kit SDK:
+
----
C:/Users/USERNAME/AppData/Local/ov/pkg/composer-2024.1.0/python.bat
----
. Or ensure system Python matches (3.10.x)

== Phase Roadmap

[plantuml, phase-roadmap, svg]
----
@startuml
!theme plain
skinparam backgroundColor #FEFEFE

[*] --> Phase1
Phase1 : âœ… Hello World
Phase1 : pybind11 basics
Phase1 : Toolchain verification

Phase1 --> Phase2
Phase2 : ğŸ“‹ Numpy Integration
Phase2 : USD stage attachment
Phase2 : Single mesh update

Phase2 --> Phase3
Phase3 : ğŸ“‹ Batch Updates
Phase3 : Multiple mesh registration
Phase3 : Batch vertex updates
Phase3 : Performance profiling

Phase3 --> Phase4
Phase4 : ğŸ“‹ Production Integration
Phase4 : Warp kernel integration
Phase4 : fabric_batch_updater.py
Phase4 : 15-Tendroid test

Phase4 --> [*]

@enduml
----

=== Phase 1: Hello World âœ…

* [x] Basic CMake configuration
* [x] pybind11 module creation
* [x] Simple test functions (strings, integers, vectors)
* [x] CLion + VS2022 toolchain verification

=== Phase 2: Numpy Integration ğŸ“‹

* [ ] Add numpy array support (zero-copy)
* [ ] USD stage attachment
* [ ] Single mesh vertex update
* [ ] Performance baseline measurement

=== Phase 3: Batch Updates ğŸ“‹

* [ ] Register multiple meshes
* [ ] Batch vertex updates from numpy arrays
* [ ] Memory-efficient bulk operations
* [ ] Performance profiling vs Python

=== Phase 4: Production Integration ğŸ“‹

* [ ] Integrate with existing Warp kernel workflow
* [ ] Update `fabric_batch_updater.py` to use C++ backend
* [ ] Multi-threading support
* [ ] Full 15-Tendroid performance test

== File Structure

----
cpp/
â”œâ”€â”€ CMakeLists.txt              # Build configuration
â”œâ”€â”€ README.adoc                 # This file
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ fast_mesh_updater.h     # Class header
â”‚   â”œâ”€â”€ fast_mesh_updater.cpp   # Implementation
â”‚   â””â”€â”€ python_bindings.cpp     # pybind11 wrapper
â””â”€â”€ cmake-build-release/        # Build artifacts (gitignored)
    â””â”€â”€ Release/
        â””â”€â”€ fast_mesh_updater.pyd
----

== Performance Goals

[cols="1,3"]
|===
|Goal |Target

|Speed improvement
|*5-10Ã— faster* than pure Python mesh updates

|Batch updates
|*Sub-millisecond* batch updates for 15 Tendroids

|Memory
|*Zero-copy* numpy array handling

|Concurrency
|*Thread-safe* for concurrent updates

|Frame rate
|*60 FPS* with 15 animated Tendroids
|===

== Contributing

When adding features:

. Keep files under 150 lines (excluding comments)
. Add tests to `test_phase1.py` (or create phase-specific test files)
. Update this README with new functionality
. Measure and document performance improvements

== Current Performance Bottleneck

[plantuml, performance-bottleneck, svg]

@startuml
!theme plain
skinparam backgroundColor #FEFEFE

start

:Warp GPU Kernel Deformation;
note right: 3.5-4ms âœ… FAST

:Copy to CPU (numpy);
note right: Negligible

:Python Tuple Conversion;
note right
  35ms âŒ BOTTLENECK
  list(map(lambda v: (float(v[0]), 
    float(v[1]), float(v[2])), vertices))
end note

:Fabric API Set Vertices;
note right: Fast once data ready

stop

note bottom
  Total: ~40ms per frame
  = ~25 FPS for 15 Tendroids
  
  **Goal:** Bypass Python tuple
  conversion with C++
end note

@enduml
----

== License

Part of the Tendroids project - see main project LICENSE.
