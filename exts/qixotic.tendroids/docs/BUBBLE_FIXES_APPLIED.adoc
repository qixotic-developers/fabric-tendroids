= Bubble Pop System - Quick Fixes Applied
:date: 2024-11-19

== Changes Made

=== 1. One Bubble Per Tendroid ✅
*File*: `config/tendroids_config.json`
*Change*: `max_bubbles_per_tendroid: 5 → 1`
*Effect*: Only one bubble exists per Tendroid at a time, preventing overlap

=== 2. Faster Bubble Rise ✅
*File*: `config/tendroids_config.json`
*Change*: `rise_speed: 35.0 → 60.0`
*Effect*: Bubbles rise ~71% faster, more realistic for 150+ unit depth

=== 3. Particle Velocity Inheritance ✅
*Files*: 
- `bubbles/bubble_manager.py`
- `bubbles/bubble_particle.py`

*Changes*:
- `_handle_bubble_pop()` now passes `bubble.physics.velocity` to particle manager
- `create_pop_spray()` accepts bubble_velocity parameter
- `_create_particle()` adds bubble velocity to spray velocity

*Effect*: Particles now inherit bubble's upward motion + radial spray

=== 4. Randomized Particle Lifetimes ✅
*File*: `bubbles/bubble_particle.py`

*Changes*:
- Each particle gets random lifetime: `base * random(0.7, 1.3)`
- Particles fade out one-by-one instead of all at once
- `PopParticle.__init__()` accepts custom lifetime parameter

*Effect*: Natural staggered disappearance

=== 5. Larger, Longer-Lasting Particles ✅
*File*: `config/tendroids_config.json`

*Changes*:
- `particle_size: 0.4 → 2.0` (5x larger, much more visible)
- `particle_lifetime: 0.6 → 2.0` (3.3x longer)  
- `gravity: -20.0 → -5.0` (4x slower fall in bubble_particle.py)

*Effect*: Particles are easily visible and linger appropriately

== Current Behavior

*Bubble Lifecycle*:
1. One bubble spawns per Tendroid when deformation appears
2. Bubble rises at 60 units/sec (realistic speed)
3. After 10-20 seconds, bubble pops at current height
4. 7 particles spray outward + upward
5. Particles inherit bubble's 60 unit/sec upward velocity
6. Particles drift and slowly fall over 1.4-2.6 seconds
7. Particles disappear one-by-one (randomized)
8. Next bubble spawns only after previous is destroyed

*Particle Physics*:
- Initial velocity = bubble velocity (0, 60, 0) + spray vector (~18 units/sec radial)
- Combined velocity ~= (spray_x, 60+spray_y, spray_z)
- Gravity -5 units/sec² slowly pulls them down
- Net effect: Particles drift upward initially, then gently arc downward

== Still TODO (Next Session)

=== Height-Based Pop Timing
Currently: Fixed time (10-20s)
Needed: Height from Tendroid mouth (150-250 units above mouth)

*Implementation*:
----
# In Bubble.__init__:
self.pop_height = tendroid_mouth_y + random.uniform(150, 250)

# In update methods:
if self.physics.position[1] >= self.pop_height and not self.has_popped:
    self.has_popped = True
    ...
----

*Benefits*:
- Consistent visual behavior regardless of rise speed
- Pops happen at predictable heights
- Easy to tune (just adjust height range)

=== Particle System Type
Current: Manual USD spheres with custom physics
Alternative: Omniverse GPU particle system

*Decision*: Keep current system
- More control over individual particles
- Good enough performance (<50 particles)
- Easy to debug and modify
- GPU particles would be premature optimization

== Testing Results Expected

After reload you should see:
1. ✅ Only ONE bubble per Tendroid at a time
2. ✅ Bubbles rise noticeably faster (60 vs 35 units/sec)
3. ✅ Pop effect visible (2.0 size particles)
4. ✅ Particles move UPWARD initially (inherit bubble velocity)
5. ✅ Particles disappear one-by-one over ~2 seconds
6. ✅ Next bubble doesn't spawn until previous is destroyed

== Configuration Reference

Current optimal settings:
----
{
  "rise_speed": 60.0,
  "max_bubbles_per_tendroid": 1,
  "min_pop_time": 10.0,
  "max_pop_time": 20.0,
  "particle_size": 2.0,
  "particle_lifetime": 2.0,
  "particle_speed": 18.0,
  "particles_per_pop": 7
}
----

Particle physics (in code):
----
gravity = -5.0  // Gentle downward drift
lifetime = base * random(0.7, 1.3)  // Staggered fade
velocity = bubble_velocity + spray_velocity  // Inherit upward motion
----

== Files Modified

1. `config/tendroids_config.json`
2. `bubbles/bubble_manager.py`
3. `bubbles/bubble_particle.py`

== Next Steps

1. Test current changes
2. If satisfactory, implement height-based popping
3. Fine-tune particle appearance/behavior
4. Consider adding fade effect (opacity reduction over time)
5. Optional: Sound effects on pop

== Status

✅ All quick fixes implemented
✅ Ready for testing
⏳ Height-based popping deferred to next session

Reload extension and observe improved behavior!
