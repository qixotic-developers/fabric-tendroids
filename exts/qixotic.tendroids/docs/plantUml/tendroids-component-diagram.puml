@startuml tendroids-component-diagram-v2

title Tendroids V2 Component Architecture - GPU Pipeline

!define GPU_COLOR #FFCDD2
!define CPU_COLOR #C5E1A5
!define FABRIC_COLOR #B39DDB
!define UI_COLOR #FFF9C4

skinparam component {
  BackgroundColor<<GPU>> GPU_COLOR
  BackgroundColor<<CPU>> CPU_COLOR
  BackgroundColor<<Fabric>> FABRIC_COLOR
  BackgroundColor<<UI>> UI_COLOR
}

component "User Interface" <<UI>> {
  [V2ControlPanel]
  [WaveControls]
  [BubbleControls]
  [ActionButtons]
}

component "Scene Management" <<CPU>> {
  [V2SceneManager]
  [V2AnimationController]
  [V2TendroidFactory]
}

component "Wave System" <<CPU>> {
  [WaveController]
  [WaveConfig]
}

component "GPU Deformation" <<GPU>> {
  [BatchWarpDeformer]
  [BatchDeformKernel]
  component "Warp GPU Arrays" {
    [base_points]
    [out_points]
    [wave_dx/dz]
  }
}

component "Fabric Write" <<Fabric>> {
  [FabricHelper]
  [FabricStage (USDRT)]
  [VtArray Write Ops]
}

component "Bubble Physics" <<GPU>> {
  [BubbleGPUManager]
  [BubblePhysics Kernel]
  component "Bubble GPU State" {
    [phases]
    [positions]
    [velocities]
  }
}

component "Particle System" <<GPU>> {
  [PopParticleGPUManager]
  [PopParticle Kernel]
}

component "USD Scene" {
  [Tendroid Meshes]
  [Bubble Spheres]
  [Particle Sprites]
  [Sea Floor]
}

component "OmniHydra Renderer" <<GPU>> {
  [Rasterizer]
  [Material Eval]
  [Lighting]
}

' User interactions
[V2ControlPanel] --> [V2SceneManager] : spawn/clear/start/stop
[WaveControls] --> [WaveController] : adjust parameters
[BubbleControls] --> [BubbleGPUManager] : trigger bubbles

' Scene orchestration
[V2SceneManager] --> [V2TendroidFactory] : create tendroids
[V2SceneManager] --> [BatchWarpDeformer] : initialize
[V2SceneManager] --> [V2AnimationController] : start/stop

' Animation loop (60 fps)
[V2AnimationController] --> [WaveController] : update(dt)
[WaveController] --> [WaveConfig] : read params
[WaveController] ..> [wave_dx/dz] : compute displacement

[V2AnimationController] --> [BubbleGPUManager] : update_gpu(dt)
[BubbleGPUManager] --> [BubblePhysics Kernel] : launch
[BubblePhysics Kernel] ..> [Bubble GPU State] : update

' Deformation pipeline
[V2AnimationController] --> [BatchWarpDeformer] : deform_all()
[BatchWarpDeformer] --> [BatchDeformKernel] : launch
[BatchDeformKernel] ..> [base_points] : read
[BatchDeformKernel] ..> [out_points] : write
[BatchDeformKernel] ..> [wave_dx/dz] : read

' Single GPU sync point
[BatchWarpDeformer] ..> [out_points] : numpy() ONCE
note on link: Critical: Single transfer\nfor all vertices

' Fabric write path
[BatchWarpDeformer] --> [FabricHelper] : apply_to_meshes_fabric()
[FabricHelper] --> [FabricStage (USDRT)] : get cached stage
[FabricHelper] --> [VtArray Write Ops] : Set() per tendroid

' Bubble visuals
[V2AnimationController] ..> [Bubble GPU State] : read state
[V2AnimationController] --> [Bubble Spheres] : update transforms

' Particle spawns
[BubbleGPUManager] --> [PopParticleGPUManager] : create pop spray
[PopParticleGPUManager] --> [PopParticle Kernel] : launch

' USD update
[VtArray Write Ops] --> [Tendroid Meshes] : vertex positions
[Tendroid Meshes] --> [OmniHydra Renderer] : render queue
[Bubble Spheres] --> [OmniHydra Renderer] : render queue
[Particle Sprites] --> [OmniHydra Renderer] : render queue
[Sea Floor] --> [OmniHydra Renderer] : render queue

note bottom of "GPU Deformation"
  **Batch Processing**
  - 15 tendroids × ~1200 vertices
  - Single kernel launch
  - ~1.0ms execution time
end note

note bottom of "Fabric Write"
  **Zero-Copy Pipeline**
  - One GPU→CPU transfer
  - Direct NumPy→VtArray
  - No tolist() overhead
  - ~0.8ms for 15 meshes
end note

note bottom of "Bubble Physics"
  **GPU State Machine**
  - 5 phases (idle/rising/exiting/released/popped)
  - Wave momentum integration
  - Elongation simulation
  - ~0.5ms execution
end note

note right of "OmniHydra Renderer"
  **Rendering Pipeline**
  - Reads from Fabric GPU
  - Zero-copy rendering
  - "Deformable" tag required
  - ~5.7ms per frame
end note

legend right
  **Performance Breakdown (115 fps)**:
  
  GPU Work: ~8.2ms (93%)
  - Deformation: 1.0ms
  - Fabric writes: 0.8ms
  - Bubble physics: 0.5ms
  - Particles: 0.2ms
  - Rendering: 5.7ms
  
  CPU Work: ~0.5ms (6%)
  - Wave calculations (NumPy)
  
  **Single GPU Sync Point**:
  - BatchDeformKernel → numpy()
  - Eliminated stuttering
  - 60→115 fps improvement
endlegend

@enduml
