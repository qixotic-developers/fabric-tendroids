@startuml tendroid-sequence-diagram-v2

title Tendroids V2 Per-Frame Update Sequence (60 fps)

actor User
participant "V2AnimationController" as Anim
participant "WaveController" as Wave
participant "BubblePhysicsAdapter" as BubbleAdapter
participant "BubbleGPUManager" as BubbleGPU
participant "BubblePhysics\nKernel" as BubbleKernel
participant "BatchWarpDeformer" as Batch
participant "BatchDeform\nKernel" as DefKernel
participant "FabricHelper" as Fabric
participant "USD/Fabric\nStage" as USD
participant "OmniHydra\nRenderer" as Render

== Initialization (Once) ==

User -> Anim: start_animation()
activate Anim
Anim -> Anim: subscribe to update events
Anim -> Batch: initialize with tendroids
Batch -> Batch: build GPU arrays\n(base_points, vertex_ids, etc.)
Anim -> BubbleAdapter: set_gpu_bubble_adapter()
BubbleAdapter -> BubbleGPU: create GPU managers
BubbleGPU -> BubbleGPU: allocate GPU arrays\n(phases, positions, velocities)
deactivate Anim

== Per-Frame Update Loop (every 16.67ms) ==

group Frame N
  Anim -> Anim: _on_update(event)
  activate Anim
  
  ' Wave update
  Anim -> Wave: update(dt)
  activate Wave
  Wave -> Wave: advance wave phase
  Wave -> Wave: compute sway (NumPy)\n~0.5ms
  Wave --> Anim: wave_state\n{phase, dx, dz per tendroid}
  deactivate Wave
  
  ' GPU Bubble Physics
  Anim -> BubbleAdapter: update_gpu(dt, wave_state)
  activate BubbleAdapter
  BubbleAdapter -> BubbleGPU: update(dt, wave_state)
  activate BubbleGPU
  
  BubbleGPU -> BubbleKernel: wp.launch(bubble_physics_kernel)
  activate BubbleKernel
  note right: GPU processes:\n- Phase transitions\n- Rising motion\n- Wave momentum\n- Elongation\n~0.5ms
  BubbleKernel --> BubbleGPU: updated GPU state
  deactivate BubbleKernel
  
  BubbleGPU -> BubbleGPU: get_bubble_states()\n[Single numpy() transfer]
  BubbleGPU --> BubbleAdapter: phases, positions, radii
  deactivate BubbleGPU
  
  BubbleAdapter -> BubbleAdapter: build bubble_data dict
  BubbleAdapter --> Anim: bubble_data per tendroid
  deactivate BubbleAdapter
  
  ' Batch Deformation
  Anim -> Batch: update_states(bubble_data, wave_state)
  activate Batch
  Batch -> Batch: update GPU arrays\n(bubble_y, bubble_radius, wave_dx/dz)
  deactivate Batch
  
  Anim -> Batch: deform_all()
  activate Batch
  Batch -> DefKernel: wp.launch(batch_deform_kernel)
  activate DefKernel
  note right: GPU processes:\n- ALL vertices\n- ALL tendroids\n- Bubble deformation\n- Wave displacement\n~1.0ms
  DefKernel --> Batch: out_points_gpu
  deactivate DefKernel
  
  ' Critical: Single GPU sync
  Batch -> Batch: all_points = out_points_gpu.numpy()\n[SINGLE GPU→CPU transfer]
  note right: Single sync point!\nEliminates stuttering
  
  ' Fabric Write Path
  Batch -> Fabric: apply_to_meshes_fabric(stage_id)
  activate Fabric
  Fabric -> Fabric: get cached Fabric stage
  
  loop For each tendroid
    Fabric -> Fabric: slice vertex data
    Fabric -> USD: points_attr.Set(VtArray(numpy_slice))
    note right: Direct NumPy→VtArray\nNo tolist() overhead
  end
  
  USD -> USD: mark attributes dirty
  Fabric --> Batch: mesh updates complete
  deactivate Fabric
  deactivate Batch
  
  ' Visual updates
  Anim -> Anim: _update_visuals_gpu(bubble_data)
  activate Anim
  loop For each bubble
    Anim -> USD: update sphere transform
    Anim -> USD: update sphere scale
    Anim -> USD: set visibility
  end
  deactivate Anim
  
  deactivate Anim
end

== Rendering (Parallel to CPU) ==

USD -> Render: dirty mesh attributes
activate Render
Render -> Render: read Fabric GPU data\n[Zero-copy!]
Render -> Render: rasterize meshes
Render -> Render: evaluate materials
Render -> Render: compute lighting
note right: ~5.7ms\nLargest single cost
Render -> User: display frame
deactivate Render

note over Anim, Render
  **Total Frame Time: ~8.7ms (115 fps)**
  
  GPU Work: 8.2ms (93%)
  - Bubble physics: 0.5ms
  - Deformation kernel: 1.0ms
  - Fabric writes: 0.8ms
  - Rendering: 5.7ms
  - Particles: 0.2ms
  
  CPU Work: 0.5ms (6%)
  - Wave calculations: 0.5ms
  
  **Critical Optimization**:
  Single GPU sync → no stuttering
end note

@enduml
