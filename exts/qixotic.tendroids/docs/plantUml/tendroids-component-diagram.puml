@startuml tendroids-component-diagram

title Tendroids Component Architecture

!define CORE_COLOR #E1F5FE
!define ANIMATION_COLOR #F3E5F5
!define SCENE_COLOR #E8F5E9
!define SEA_FLOOR_COLOR #B2EBF2
!define CONFIG_COLOR #C8E6C9
!define UI_COLOR #FFF9C4
!define UTILS_COLOR #FFE0B2
!define EXTERNAL_COLOR #FFEBEE

skinparam componentStyle rectangle

package "Tendroids Extension" {
  
  component "Extension Entry" as ExtEntry {
    [TendroidsExtension]
    
    note right of TendroidsExtension
      on_startup():
      - Create SceneManager
      - Create ControlPanel
      
      on_shutdown():
      - Cleanup SceneManager
      - Destroy UI
    end note
  }
  
  package "Configuration" CONFIG_COLOR {
    component "Config System" as ConfigSystem {
      [ConfigLoader]
      [get_config_value]
      
      database "tendroids_config.json" as ConfigDB
      
      note right of ConfigLoader
        Hybrid config:
        - Loads JSON overrides
        - Merges with Python defaults
        - Caching for performance
        - Type-safe fallback
      end note
    }
  }
  
  package "Core Components" CORE_COLOR {
    
    component "Tendroid" as TendroidComp {
      [Tendroid]
      
      note right of Tendroid
        Main controller
        Delegates to:
        - Builder (creation)
        - Lifecycle (state)
        - Components (animation)
      end note
    }
    
    component "USD Creation" as USDCreation {
      [TendroidBuilder]
      [CylinderGenerator]
      [TerrainConform]
      
      note right of TendroidBuilder
        Reads geometry params
        from config system
      end note
    }
    
    component "Vertex Deformation" as Deformation {
      [WarpDeformer]
      [GPU Kernel]
      
      note right of GPU Kernel
        CUDA kernel:
        deform_breathing_bulge()
        Processes vertices in parallel
      end note
    }
    
    component "Safety System" as Safety {
      [MaterialSafetyChecker]
      
      note right of MaterialSafetyChecker
        Prevents GPU crashes
        Detects glass materials
        Blocks unsafe animation
      end note
    }
    
    component "Mesh Updates" as MeshUpdates {
      [MeshVertexUpdater]
    }
    
    component "Lifecycle" as Lifecycle {
      [TendroidLifecycle]
    }
  }
  
  package "Animation Components" ANIMATION_COLOR {
    
    component "Breathing" as Breathing {
      [BreathingAnimator]
      
      note right of BreathingAnimator
        Wave timing calculations
        Bubble emission detection
        Parameter management
        Reads animation params
        from config system
      end note
    }
    
    component "Idle Motion" as IdleMotion {
      [IdleMotionAnimator]
      
      note bottom of IdleMotionAnimator
        Not yet integrated
        Ready for Phase 2
      end note
    }
  }
  
  package "Sea Floor" SEA_FLOOR_COLOR {
    
    component "Terrain Generation" as TerrainGen {
      [SeaFloorConfig]
      [SeaFloorController]
      [SeaFloorHelper]
      
      note right of SeaFloorConfig
        from_json() classmethod
        Loads terrain params
      end note
      
      note right of SeaFloorHelper
        Perlin noise generation
        Height map caching
        get_height_at(x, z)
      end note
    }
    
    component "Environment Setup" as EnvSetup {
      [EnvironmentConfig]
      [EnvironmentSetup]
      
      note right of EnvironmentConfig
        Sky, Light, Material
        from_json() classmethods
      end note
    }
  }
  
  package "Scene Management" SCENE_COLOR {
    
    component "Scene Coordinator" as SceneCoord {
      [TendroidSceneManager]
      
      note right of TendroidSceneManager
        High-level orchestrator
        Manages Tendroid collection
        Creates sea floor
        Delegates to:
        - Factory (creation)
        - AnimationController (updates)
        - SeaFloorController (terrain)
      end note
    }
    
    component "Animation Loop" as AnimLoop {
      [AnimationController]
      
      note right of AnimationController
        Update subscription
        Frame-by-frame updates
        Delta time management
      end note
    }
    
    component "Creation Patterns" as CreationPatterns {
      [TendroidFactory]
      
      note right of TendroidFactory
        create_single()
        create_batch()
        Parameter variations
        Reads spawning params
        from config system
      end note
    }
  }
  
  package "User Interface" UI_COLOR {
    
    component "Control Panel" as ControlPanel {
      [TendroidControlPanel]
      
      note right of TendroidControlPanel
        Main UI coordinator
        Wires together:
        - SpawnSettings
        - ActionButtons
        - StatusDisplay
      end note
    }
    
    component "Spawn Settings" as SpawnSettings {
      [SpawnSettingsUI]
      
      note right of SpawnSettingsUI
        Single/Multi modes
        Parameter controls
        Conditional visibility
      end note
    }
    
    component "Actions" as Actions {
      [ActionButtons]
      
      note right of ActionButtons
        Spawn Tendroids
        Start/Stop Animation
        Clear All
      end note
    }
    
    component "Status" as Status {
      [StatusDisplay]
      
      note right of StatusDisplay
        Status messages
        Tendroid count
        Animation state
      end note
    }
  }
  
  package "Utilities" UTILS_COLOR {
    
    component "Math" as Math {
      [MathHelpers]
      
      note right of MathHelpers
        smooth_step
        ease_out_quartic
        calculate_flare_radius
        calculate_wave_displacement
        calculate_wave_position
      end note
    }
  }
}

package "External Dependencies" EXTERNAL_COLOR {
  
  component "Omniverse" as Omniverse {
    [USD Stage]
    [UsdGeom]
    [omni.ui]
    [omni.kit]
  }
  
  component "NVIDIA Warp" as Warp {
    [Warp Runtime]
    [CUDA Backend]
  }
  
  component "NumPy" as NumPy {
    [numpy]
    [Perlin noise]
  }
}

' Component relationships

ExtEntry --> SceneCoord : creates & manages
ExtEntry --> ControlPanel : creates & owns

' Config relationships
ConfigSystem o-- ConfigDB : reads from
USDCreation --> ConfigSystem : reads geometry params
Breathing --> ConfigSystem : reads animation params
CreationPatterns --> ConfigSystem : reads spawning params
TerrainGen --> ConfigSystem : reads terrain params
EnvSetup --> ConfigSystem : reads environment params

ControlPanel --> SceneCoord : controls
ControlPanel *-- SpawnSettings : contains
ControlPanel *-- Actions : contains
ControlPanel *-- Status : contains

Actions --> SceneCoord : calls methods
Actions --> SpawnSettings : reads parameters
Actions --> Status : updates display

SceneCoord *-- AnimLoop : contains
SceneCoord ..> CreationPatterns : uses
SceneCoord ..> TerrainGen : uses

AnimLoop o-- TendroidComp : updates

CreationPatterns ..> TendroidComp : creates
CreationPatterns ..> USDCreation : uses

TendroidComp --> USDCreation : delegates creation
TendroidComp --> Lifecycle : delegates lifecycle
TendroidComp *-- Deformation : contains
TendroidComp *-- Breathing : contains
TendroidComp *-- Safety : contains
TendroidComp *-- MeshUpdates : contains

USDCreation ..> Math : uses
USDCreation ..> TerrainGen : conforms to terrain
Deformation ..> Math : uses
Breathing ..> Math : uses
TerrainGen ..> Math : uses

TendroidComp ..> Omniverse : uses USD API
USDCreation --> Omniverse : creates prims
MeshUpdates --> Omniverse : writes vertices
TerrainGen --> Omniverse : creates mesh
EnvSetup --> Omniverse : creates sky/lights
ControlPanel --> Omniverse : uses omni.ui

Deformation --> Warp : launches kernels
TerrainGen --> NumPy : Perlin noise generation

interface "IExt" as IExtInterface
ExtEntry .up.|> IExtInterface

interface "Update Events" as UpdateInterface
AnimLoop .up.|> UpdateInterface

note as N1
  **Data Flow**:
  1. User interacts with UI
  2. ActionButtons call SceneManager
  3. SceneManager creates sea floor
  4. SceneManager uses Factory
  5. Factory creates Tendroids
  6. Tendroids conform to terrain
  7. AnimationController updates Tendroids
  8. Tendroids use Warp for deformation
  9. Deformed vertices written to USD
end note

note as N2
  **Key Patterns**:
  - Builder: USD creation
  - Factory: Tendroid instantiation
  - Lifecycle: State management
  - Component: Specialized responsibilities
  - Coordinator: SceneManager & ControlPanel
  - Config: Hybrid JSON/Python system
end note

note as N3
  **Configuration System**:
  All major components read
  parameters from JSON config:
  - Geometry (flare, segments)
  - Animation (wave, amplitude)
  - Spawning (count, area)
  - Terrain (size, amplitude)
  - Environment (sky, lights)
  
  Provides runtime tweakability
  without code changes
end note

@enduml
