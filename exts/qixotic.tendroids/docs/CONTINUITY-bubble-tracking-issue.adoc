= Bubble Tracking Issue - RESOLVED
:doctype: article
:toc: left
:date: 2025-11-24

== Resolution Summary

**STATUS**: FIXED

Three issues were identified and resolved:

1. **Bubbles not following centerline** - Wave was queried twice per frame
2. **Bubble stops tracking during rise** - Same root cause as #1
3. **diameter_multiplier backward** - Visual scale wasn't using it consistently

== Root Cause Analysis

=== Issue 1 & 2: Double Wave Query

The original code queried wave displacement TWICE per update:

[source,python]
----
# In _update_rising():
wave_dx, wave_dz = self._get_wave_displacement(wave_controller)  # Query 1
self.tendroid.apply_deformation(self.y, effective_radius, wave_dx, wave_dz)

# Then later:
self._update_world_pos_with_wave(wave_controller)  # Query 2 (different values!)
----

The `_update_world_pos_with_wave()` method made its OWN call to `get_displacement()`, which could return different values if the wave function is time-dependent or if there's any timing variance.

=== Issue 3: Inconsistent Scale

The `diameter_multiplier` was only applied to deformation radius:
[source,python]
----
effective_radius = self.current_radius * self.config.diameter_multiplier
----

But the visual bubble scale used a hardcoded factor:
[source,python]
----
r = self.current_radius * 0.95  # Not using diameter_multiplier!
----

This meant lower `diameter_multiplier` = smaller bulge = bubble pokes through.

== The Fix

=== Fix 1: Single Wave Query with Caching

New method `_update_world_pos_from_cached_wave()` uses the SAME wave values that were passed to deformation:

[source,python]
----
def _update_world_pos_from_cached_wave(self):
    """Uses cached wave values - no second query."""
    tx, ty, tz = self.tendroid.position
    self.world_pos[1] = ty + self.y
    
    # Apply height scaling (matches GPU kernel exactly)
    height_ratio = min(1.0, self.y / self.tendroid.length)
    factor = height_ratio * height_ratio * (3.0 - 2.0 * height_ratio)
    
    # Use CACHED values from _get_wave_displacement()
    self.world_pos[0] = tx + self._last_wave_dx * factor
    self.world_pos[2] = tz + self._last_wave_dz * factor
----

=== Fix 2: Consistent Visual Scale

Visual scale now uses 92% of bubble radius (smaller than deformation bulge):

[source,python]
----
def _update_scale(self):
    r = self.current_radius * 0.92  # Always inside the bulge
----

Combined with `diameter_multiplier = 1.15` (default), the deformation bulge is 15% bigger than the bubble, and the visual is 8% smaller than the bubble, guaranteeing the visual stays inside.

=== Fix 3: Clarified Config

Updated `bubble_config.py` with clear documentation:
[source,python]
----
diameter_multiplier: float = 1.15   # Deformation bulge size relative to bubble
                                    # > 1.0 = bulge bigger than bubble (hidden inside)
                                    # < 1.0 = bubble bigger than bulge (pokes through)
----

== Files Modified

- `qixotic/tendroids/v2/bubbles/bubble_manager.py`
  * Added `_update_world_pos_from_cached_wave()` method
  * Modified `_update_rising()` to use cached wave
  * Modified `_update_exiting()` to use cached wave
  * Updated `_update_scale()` with clear documentation

- `qixotic/tendroids/v2/bubbles/bubble_config.py`
  * Updated `diameter_multiplier` default to 1.15
  * Added documentation explaining the parameter

== Testing Checklist

[%interactive]
* [ ] Single tendroid with wave enabled - bubble follows centerline
* [ ] Multiple tendroids with spatial variation - bubbles track correctly
* [ ] Lower diameter_multiplier values - bubble stays inside
* [ ] Higher diameter_multiplier values - bubble stays inside (bigger margin)
* [ ] Exit transition - bubble continues tracking during exit
* [ ] Wave disabled - bubble rises straight up center

== Key Insight

**Never query time-dependent values twice when you need them to match.**

The GPU kernel and bubble visual both need the SAME wave displacement values. By querying wave once and caching it, we guarantee synchronization regardless of timing or computational variance.

== Previous Session Reference

See `SESSION-SUMMARY-2025-11-23.adoc` for context on how this issue was discovered.
