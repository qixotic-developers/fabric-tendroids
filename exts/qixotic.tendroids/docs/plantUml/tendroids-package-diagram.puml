@startuml
title Tendroids Project - Package Diagram: Refactored Python Module Structure

skinparam packageStyle rectangle

package "exts/qixotic.tendroids" {

    package "config" <<Folder>> {
        [extension.toml] as ExtToml
        note bottom of ExtToml
            Extension metadata
            - Name: qixotic.tendroids
            - Version: 1.0.0
            - Dependencies: omni.kit.*
        end note
    }

    package "qixotic.tendroids" <<Python Package>> {
        [extension.py] as Extension
        [__init__.py] as RootInit

        package "core" <<Python Package>> {
            [tendroid.py] as Tendroid
            [tendroid_builder.py] as Builder
            [tendroid_lifecycle.py] as Lifecycle
            [material_safety.py] as Safety
            [mesh_updater.py] as Updater
            [cylinder_generator.py] as CylGen
            [warp_deformer.py] as WarpDef
            [__init__.py] as CoreInit

            note right of Tendroid
                ~165 lines (was 325)
                Core Tendroid class
                Delegates to Builder & Lifecycle
            end note

            note right of Builder
                ~145 lines (NEW)
                Builder pattern for
                USD geometry creation
            end note

            note right of Lifecycle
                ~126 lines (NEW)
                Lifecycle management
                (activate, destroy, status)
            end note

            note right of Safety
                ~133 lines (NEW)
                Glass material detection
                Prevents GPU crashes
            end note

            note right of Updater
                ~57 lines (NEW)
                USD mesh vertex updates
                Clean abstraction
            end note
        }

        package "scene" <<Python Package>> {
            [manager.py] as SceneMgr
            [tendroid_factory.py] as Factory
            [animation_controller.py] as AnimCtrl
            [__init__.py] as SceneInit

            note right of SceneMgr
                ~165 lines (was 269)
                Scene coordinator
                Delegates to Factory & Controller
            end note

            note right of Factory
                ~136 lines (NEW)
                Factory pattern for
                Tendroid creation
            end note

            note right of AnimCtrl
                ~98 lines (NEW)
                Animation lifecycle
                Update loop management
            end note
        }

        package "animation" <<Python Package>> {
            [breathing.py] as Breathing
            [__init__.py] as AnimInit

            note right of Breathing
                ~180 lines
                Breathing wave animation
                Frequency/amplitude control
            end note
        }

        package "ui" <<Python Package>> {
            [control_panel.py] as ControlPanel
            [spawn_settings_ui.py] as SpawnUI
            [action_buttons.py] as Actions
            [status_display.py] as Status
            [__init__.py] as UIInit

            note right of ControlPanel
                ~102 lines (was 401)
                Main UI coordinator
                Delegates to specialized UIs
            end note

            note right of SpawnUI
                ~179 lines (NEW)
                Spawn parameter controls
                Single/multi mode switching
            end note

            note right of Actions
                ~180 lines (NEW)
                Button handlers
                Spawn/start/stop/clear
            end note

            note right of Status
                ~61 lines (NEW)
                Status label management
                Clean updates
            end note
        }
    }

    package "docs" <<Folder>> {
        [README.adoc] as Readme
        [CHANGELOG.adoc] as Changelog
        [PROJECT_OVERVIEW.adoc] as Overview
        [IMPLEMENTATION_STATUS.adoc] as Status
        
        package "plantUml" <<Folder>> {
            [tendroid-class-diagram.puml]
            [tendroid-sequence-diagram.puml]
            [tendroid-state-diagram.puml]
            [tendroids-activity-diagram.puml]
            [tendroids-component-diagram.puml]
            [tendroids-package-diagram.puml]
        }
    }
}

' Dependencies between packages
Extension ..> CoreInit : imports
Extension ..> ControlPanel : creates

ControlPanel ..> SpawnUI : contains
ControlPanel ..> Actions : contains
ControlPanel ..> Status : contains
Actions ..> SceneMgr : controls

SceneMgr ..> Factory : creates via
SceneMgr ..> AnimCtrl : delegates to
Factory ..> Tendroid : creates
AnimCtrl ..> Tendroid : animates

Tendroid ..> Builder : delegates creation
Tendroid ..> Lifecycle : delegates lifecycle
Builder ..> CylGen : uses
Builder ..> Safety : creates
Builder ..> Updater : creates
Builder ..> WarpDef : creates
Builder ..> Breathing : creates

' External dependencies
package "External Dependencies" {
    [omni.kit.ui] as KitUI
    [omni.usd] as OmniUSD
    [pxr (USD)] as PXR
    [warp] as Warp
    [numpy] as Numpy
}

ControlPanel ..> KitUI : UI components
SceneMgr ..> OmniUSD : stage access
Tendroid ..> PXR : UsdGeom
WarpDef ..> Warp : GPU kernels

legend right
    **Refactoring Results**
    
    **Files Refactored:**
    • control_panel.py: 401 → 102 lines (-75%)
    • tendroid.py: 325 → 165 lines (-50%)
    • manager.py: 269 → 165 lines (-39%)
    
    **New Modules Created: 9**
    UI: spawn_settings_ui, action_buttons, status_display
    Core: tendroid_builder, tendroid_lifecycle,
          material_safety, mesh_updater
    Scene: tendroid_factory, animation_controller
    
    **Total Project Size:**
    ~2,200 lines (including new modules)
    All files now under 200 lines
    Clean separation of concerns
endlegend

@enduml
